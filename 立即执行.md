# ç«‹å³æ‰§è¡Œ - OAuthç™»å½•ä¿®å¤ï¼ˆåŸºäºCASå®˜æ–¹æ–‡æ¡£ï¼‰

## ğŸ¯ é—®é¢˜ç°çŠ¶

- âŒ Edge Functionè¿”å›500é”™è¯¯
- âŒ é”™è¯¯ä¿¡æ¯ï¼š`error=invalid_request`
- âŒ CASæœåŠ¡å™¨è¿”å›400

## ğŸ“– æ ¹æœ¬åŸå› 

æ ¹æ®**CAS OAuth 2.0å®˜æ–¹æ–‡æ¡£**ï¼Œæˆ‘ä»¬ä¹‹å‰çš„å®ç°ä¸ç¬¦åˆCASçš„è¦æ±‚ï¼š

- âŒ ä¹‹å‰ï¼šä¼˜å…ˆä½¿ç”¨Basic Authï¼ˆCASä¸æ”¯æŒï¼‰
- âŒ ä¹‹å‰ï¼šå‚æ•°åœ¨è¯·æ±‚ä½“ä¸­
- âœ… **CASè¦æ±‚**ï¼šä½¿ç”¨GETè¯·æ±‚ï¼Œå‚æ•°åœ¨URLä¸­

## âœ… è§£å†³æ–¹æ¡ˆ

å·²æ ¹æ®**CASå®˜æ–¹æ–‡æ¡£**é‡æ–°å®ç°ï¼Œå®Œå…¨ç¬¦åˆCASè¦æ±‚ï¼š

### CASå®˜æ–¹ç¤ºä¾‹

```http
GET /cas/oauth2.0/accessToken?grant_type=authorization_code&client_id=902&client_secret=902&redirect_uri=https://example.com/oauth2/authcode&code=OC-2-xxx HTTP/1.1
```

### æˆ‘ä»¬çš„å®ç°

1. **æ–¹å¼1**: GETè¯·æ±‚ï¼Œå‚æ•°åœ¨URLä¸­ï¼ˆCASæ ‡å‡†ï¼‰âœ…
2. **æ–¹å¼2**: POSTè¯·æ±‚ï¼Œå‚æ•°åœ¨URLä¸­ï¼ˆCASå¤‡é€‰ï¼‰
3. **æ–¹å¼3**: POSTè¯·æ±‚ï¼Œå‚æ•°åœ¨è¯·æ±‚ä½“ä¸­ï¼ˆå…¼å®¹å…¶ä»–OAuthï¼‰

## ğŸ“‹ æ‰§è¡Œæ­¥éª¤

### ç¬¬1æ­¥ï¼šé‡æ–°éƒ¨ç½²Edge Function

```bash
cd ~/projects/app-7z58i603if41
./redeploy-edge-function.sh
```

**é¢„æœŸè¾“å‡º**ï¼š
```
=========================================
  é‡æ–°éƒ¨ç½²Edge Function
=========================================

1. å½“å‰Edge Functionåˆ—è¡¨:
...

2. é‡æ–°éƒ¨ç½²oauth-callbackå‡½æ•°...
âœ“ Edge Functionéƒ¨ç½²æˆåŠŸ

3. æŸ¥çœ‹æœ€æ–°æ—¥å¿—...
...
```

---

### ç¬¬2æ­¥ï¼šæµ‹è¯•Edge Function

```bash
./check-supabase.sh
```

**é¢„æœŸç»“æœ**ï¼š

âœ… **æˆåŠŸæƒ…å†µ**ï¼š
```
HTTPçŠ¶æ€ç : 200
å“åº”å†…å®¹: {"success":true,...}
```

æˆ–è€…ï¼š
```
HTTPçŠ¶æ€ç : 400
å“åº”å†…å®¹: {"error":"invalid_grant"}
```
ï¼ˆè¿™æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸ºtest codeæ— æ•ˆï¼‰

âŒ **ä»ç„¶å¤±è´¥**ï¼š
```
HTTPçŠ¶æ€ç : 500
å“åº”å†…å®¹: {"error":"è·å–access_tokenå¤±è´¥"}
```
ï¼ˆå¦‚æœçœ‹åˆ°è¿™ä¸ªï¼Œè¯·æŸ¥çœ‹Edge Functionæ—¥å¿—ï¼‰

---

### ç¬¬3æ­¥ï¼šæŸ¥çœ‹Edge Functionæ—¥å¿—

```bash
supabase functions logs oauth-callback --follow
```

**å…³é”®æ—¥å¿—å†…å®¹**ï¼š

âœ… **æˆåŠŸçš„æ—¥å¿—**ï¼ˆæ–¹å¼1æˆåŠŸï¼‰ï¼š
```
æ”¶åˆ°æˆæƒç ï¼Œå¼€å§‹æ¢å–access_token...
Token URL: https://cas.wzbc.edu.cn/cas/oauth2.0/accessToken
Client ID: CijBwB5EwTTXouO7
Redirect URI: https://aigctmp.wzbc.edu.cn/auth/callback
Code: OC-2-xxx...
æ–¹å¼1: GETè¯·æ±‚ï¼ˆCASæ ‡å‡†æ–¹å¼ï¼‰
å®Œæ•´URL: https://cas.wzbc.edu.cn/cas/oauth2.0/accessToken?grant_type=authorization_code&client_id=...
Tokenå“åº”: { access_token: "AT-1-...", token_type: "bearer", expires_in: 28800 }
æˆåŠŸè·å–access_tokenï¼Œå¼€å§‹è·å–ç”¨æˆ·ä¿¡æ¯...
Profileå“åº”: { id: "å­¦å·", attributes: { name: "å§“å", ... } }
```

âœ… **æˆåŠŸçš„æ—¥å¿—**ï¼ˆæ–¹å¼2æˆåŠŸï¼‰ï¼š
```
æ–¹å¼1: GETè¯·æ±‚ï¼ˆCASæ ‡å‡†æ–¹å¼ï¼‰
GETè¯·æ±‚å¤±è´¥ï¼Œå°è¯•æ–¹å¼2: POSTè¯·æ±‚ï¼Œå‚æ•°åœ¨URL
Tokenå“åº”: { access_token: "AT-1-...", ... }
æˆåŠŸè·å–access_tokenï¼Œå¼€å§‹è·å–ç”¨æˆ·ä¿¡æ¯...
```

âœ… **æˆåŠŸçš„æ—¥å¿—**ï¼ˆæ–¹å¼3æˆåŠŸï¼‰ï¼š
```
æ–¹å¼1: GETè¯·æ±‚ï¼ˆCASæ ‡å‡†æ–¹å¼ï¼‰
GETè¯·æ±‚å¤±è´¥ï¼Œå°è¯•æ–¹å¼2: POSTè¯·æ±‚ï¼Œå‚æ•°åœ¨URL
POST+URLå¤±è´¥ï¼Œå°è¯•æ–¹å¼3: POSTè¯·æ±‚ï¼Œå‚æ•°åœ¨è¯·æ±‚ä½“
Tokenå“åº”: { access_token: "AT-1-...", ... }
æˆåŠŸè·å–access_tokenï¼Œå¼€å§‹è·å–ç”¨æˆ·ä¿¡æ¯...
```

âŒ **å¤±è´¥çš„æ—¥å¿—**ï¼š
```
Token exchange failed: {
  status: 400,
  error: "error=invalid_request",
  ...
}
```

---

### ç¬¬4æ­¥ï¼šæµ‹è¯•çœŸå®ç™»å½•

1. **æ‰“å¼€æµè§ˆå™¨**ï¼Œè®¿é—®ï¼šhttps://aigctmp.wzbc.edu.cn

2. **æŒ‰F12**æ‰“å¼€å¼€å‘è€…å·¥å…·

3. **åˆ‡æ¢åˆ°Consoleæ ‡ç­¾**

4. **ç‚¹å‡»"ç™»å½•"æŒ‰é’®**

5. **è¾“å…¥å­¦å·å’Œå¯†ç **

6. **æŸ¥çœ‹æ§åˆ¶å°è¾“å‡º**

âœ… **æˆåŠŸçš„è¾“å‡º**ï¼š
```
å¼€å§‹è°ƒç”¨Edge Functionï¼Œå‚æ•°: { code: "ST-...", state: "" }
Edge Functionå“åº”: { data: { success: true, userInfo: {...} }, error: null }
ç™»å½•æˆåŠŸï¼æ­£åœ¨è·³è½¬...
```

âŒ **å¤±è´¥çš„è¾“å‡º**ï¼š
```
Edge Functioné”™è¯¯: è·å–access_tokenå¤±è´¥
```

---

## ğŸ” è°ƒè¯•æŠ€å·§

### å®æ—¶æŸ¥çœ‹æ—¥å¿—

åœ¨ä¸€ä¸ªç»ˆç«¯çª—å£è¿è¡Œï¼š
```bash
supabase functions logs oauth-callback --follow
```

ç„¶ååœ¨æµè§ˆå™¨ä¸­æµ‹è¯•ç™»å½•ï¼Œå¯ä»¥å®æ—¶çœ‹åˆ°ï¼š
- æ¥æ”¶åˆ°çš„æˆæƒç 
- å°è¯•çš„è¯·æ±‚æ–¹å¼
- Tokenå“åº”
- ç”¨æˆ·ä¿¡æ¯
- ä»»ä½•é”™è¯¯ä¿¡æ¯

### æŸ¥çœ‹ç½‘ç»œè¯·æ±‚

1. æŒ‰F12æ‰“å¼€å¼€å‘è€…å·¥å…·
2. åˆ‡æ¢åˆ°**Network**æ ‡ç­¾
3. ç‚¹å‡»ç™»å½•
4. æ‰¾åˆ°`oauth-callback`è¯·æ±‚
5. æŸ¥çœ‹ï¼š
   - Request Headers
   - Request Payload
   - Response Headers
   - Response Body

---

## âœ… éªŒè¯æ¸…å•

å®Œæˆåï¼Œè¯·ç¡®è®¤ï¼š

- [ ] æ‰§è¡Œäº†`./redeploy-edge-function.sh`
- [ ] Edge Functionç‰ˆæœ¬å·å¢åŠ äº†
- [ ] æµ‹è¯•è„šæœ¬ä¸å†è¿”å›`invalid_request`
- [ ] å¯ä»¥è®¿é—®ç½‘ç«™
- [ ] å¯ä»¥ç‚¹å‡»ç™»å½•å¹¶è·³è½¬åˆ°CAS
- [ ] è¾“å…¥è´¦å·å¯†ç åèƒ½è¿”å›ç½‘ç«™
- [ ] æµè§ˆå™¨æ§åˆ¶å°æ— 500é”™è¯¯
- [ ] Edge Functionæ—¥å¿—æ˜¾ç¤ºæˆåŠŸè·å–access_token
- [ ] ç™»å½•æˆåŠŸï¼ŒHeaderæ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

| æ–‡æ¡£ | è¯´æ˜ |
|------|------|
| **å¿«é€Ÿä¿®å¤æŒ‡å—.md** | å¿«é€Ÿå‚è€ƒå’ŒæŠ€æœ¯ç»†èŠ‚ |
| **OAuthè¯·æ±‚ä¿®å¤è®°å½•.md** | å®Œæ•´çš„ä¿®æ”¹å†å²ï¼ˆ4æ¬¡å°è¯•ï¼‰ |
| **è§£å†³500é”™è¯¯.md** | 500é”™è¯¯çš„è¯¦ç»†è§£å†³æ–¹æ¡ˆ |
| **ä¿®å¤401é”™è¯¯æŒ‡å—.md** | 401é”™è¯¯çš„è§£å†³æ–¹æ¡ˆ |

---

## ğŸ†˜ ä»ç„¶å¤±è´¥ï¼Ÿ

å¦‚æœæ‰§è¡Œä¸Šè¿°æ­¥éª¤åä»ç„¶å¤±è´¥ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

### 1. é‡æ–°éƒ¨ç½²è¾“å‡º
```bash
./redeploy-edge-function.sh 2>&1 | tee deploy.log
cat deploy.log
```

### 2. æµ‹è¯•ç»“æœ
```bash
./check-supabase.sh 2>&1 | tee test.log
cat test.log
```

### 3. Edge Functionæ—¥å¿—
```bash
supabase functions logs oauth-callback --limit 50
```

### 4. æµè§ˆå™¨æ§åˆ¶å°è¾“å‡º
- æŒ‰F12 â†’ Consoleæ ‡ç­¾
- å¤åˆ¶æ‰€æœ‰çº¢è‰²é”™è¯¯ä¿¡æ¯

### 5. ç½‘ç»œè¯·æ±‚è¯¦æƒ…
- æŒ‰F12 â†’ Networkæ ‡ç­¾
- æ‰¾åˆ°`oauth-callback`è¯·æ±‚
- å³é”® â†’ Copy â†’ Copy as cURL

---

## ğŸ‰ æˆåŠŸæ ‡å¿—

å½“ä½ çœ‹åˆ°ä»¥ä¸‹å†…å®¹æ—¶ï¼Œè¯´æ˜ä¿®å¤æˆåŠŸï¼š

1. âœ… æµ‹è¯•è„šæœ¬è¿”å›200æˆ–400ï¼ˆä¸æ˜¯500ï¼‰
2. âœ… Edge Functionæ—¥å¿—æ˜¾ç¤º"æˆåŠŸè·å–access_token"
3. âœ… æµè§ˆå™¨æ§åˆ¶å°æ˜¾ç¤º"ç™»å½•æˆåŠŸï¼æ­£åœ¨è·³è½¬..."
4. âœ… Headeræ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯ï¼ˆå­¦å·ã€å§“åç­‰ï¼‰
5. âœ… å¯ä»¥æ­£å¸¸ä½¿ç”¨ç½‘ç«™åŠŸèƒ½

---

**å‡†å¤‡å¥½äº†å—ï¼Ÿå¼€å§‹æ‰§è¡Œç¬¬1æ­¥ï¼** ğŸš€

```bash
cd ~/projects/app-7z58i603if41
./redeploy-edge-function.sh
```
