# å¿«é€Ÿä¿®å¤æŒ‡å—

## å½“å‰é—®é¢˜

Edge Functionè¿”å›500é”™è¯¯ï¼š`error=invalid_request`ï¼ŒCASæœåŠ¡å™¨è¿”å›400

## æœ€æ–°ä¿®å¤æ–¹æ¡ˆ

âœ… **å®ç°OAuthè¯·æ±‚çš„æ™ºèƒ½é‡è¯•æœºåˆ¶**

- ä¿®æ”¹æ–‡ä»¶ï¼š`supabase/functions/oauth-callback/index.ts`
- ä¿®æ”¹ä½ç½®ï¼šç¬¬66-140è¡Œ
- æ ¸å¿ƒç­–ç•¥ï¼šè‡ªåŠ¨å°è¯•ä¸‰ç§OAuthè¯·æ±‚æ–¹å¼

### ä¸‰ç§è¯·æ±‚æ–¹å¼

1. **æ–¹å¼1**: HTTP Basic Authenticationï¼ˆæ ‡å‡†OAuth 2.0ï¼‰
   - å®¢æˆ·ç«¯å‡­è¯é€šè¿‡Authorization headerä¼ é€’
   - æœ€ç¬¦åˆOAuth 2.0æ ‡å‡†

2. **æ–¹å¼2**: POST + å‚æ•°åœ¨è¯·æ±‚ä½“ï¼ˆå¸¸è§å®ç°ï¼‰
   - æ‰€æœ‰å‚æ•°åœ¨è¯·æ±‚ä½“ä¸­
   - é€‚ç”¨äºå¤§å¤šæ•°OAuthæœåŠ¡å™¨

3. **æ–¹å¼3**: GET + å‚æ•°åœ¨URLï¼ˆCASç‰¹æ®Šå®ç°ï¼‰
   - æ‰€æœ‰å‚æ•°ä½œä¸ºURLæŸ¥è¯¢å‚æ•°
   - é€‚é…æŸäº›æ—§ç‰ˆCASæœåŠ¡å™¨

### å·¥ä½œåŸç†

```
å°è¯•æ–¹å¼1 (Basic Auth)
  â†“ å¤±è´¥ï¼Ÿ
å°è¯•æ–¹å¼2 (POST + body)
  â†“ å¤±è´¥ï¼Ÿ
å°è¯•æ–¹å¼3 (GET + URL)
  â†“ æˆåŠŸï¼
è¿”å›ç”¨æˆ·ä¿¡æ¯
```

## ç«‹å³æ‰§è¡Œ

### 1. é‡æ–°éƒ¨ç½²Edge Function

```bash
cd ~/projects/app-7z58i603if41
./redeploy-edge-function.sh
```

### 2. æµ‹è¯•ä¿®å¤ç»“æœ

```bash
./check-supabase.sh
```

**é¢„æœŸç»“æœ**ï¼š
- âŒ ä¹‹å‰ï¼š`error=invalid_request`ï¼ˆCASè¿”å›400ï¼‰
- âœ… ç°åœ¨ï¼šåº”è¯¥æˆåŠŸï¼Œæˆ–è¿”å›`error=invalid_grant`ï¼ˆtest codeæ— æ•ˆï¼Œæ­£å¸¸ï¼‰
- âœ… æ—¥å¿—ä¼šæ˜¾ç¤ºå°è¯•äº†å“ªç§æ–¹å¼æˆåŠŸ

### 3. æŸ¥çœ‹å®æ—¶æ—¥å¿—

```bash
supabase functions logs oauth-callback --follow
```

**å…³é”®æ—¥å¿—**ï¼š
```
å°è¯•æ–¹å¼1: Basic Auth
è¯·æ±‚å‚æ•°: grant_type=authorization_code&code=...
```

å¦‚æœæ–¹å¼1å¤±è´¥ï¼Œä¼šçœ‹åˆ°ï¼š
```
Basic Authå¤±è´¥ï¼Œå°è¯•æ–¹å¼2: å‚æ•°åœ¨è¯·æ±‚ä½“
```

å¦‚æœæ–¹å¼2ä¹Ÿå¤±è´¥ï¼Œä¼šçœ‹åˆ°ï¼š
```
POSTè¯·æ±‚å¤±è´¥ï¼Œå°è¯•æ–¹å¼3: GETè¯·æ±‚
```

### 4. æµ‹è¯•çœŸå®ç™»å½•

1. è®¿é—® https://aigctmp.wzbc.edu.cn
2. ç‚¹å‡»"ç™»å½•"
3. è¾“å…¥å­¦å·å’Œå¯†ç 
4. åº”è¯¥èƒ½æˆåŠŸç™»å½•

## æŠ€æœ¯ç»†èŠ‚

### æ™ºèƒ½é‡è¯•æœºåˆ¶

```typescript
// æ–¹å¼1: Basic Auth
const basicAuth = btoa(`${clientId}:${clientSecret}`);
let response = await fetch(tokenUrl, {
  method: 'POST',
  headers: { 'Authorization': `Basic ${basicAuth}` },
  body: 'grant_type=authorization_code&code=...&redirect_uri=...'
});

// æ–¹å¼2: POST + bodyå‚æ•°
if (!response.ok) {
  response = await fetch(tokenUrl, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: 'grant_type=...&code=...&client_id=...&client_secret=...'
  });
}

// æ–¹å¼3: GET + URLå‚æ•°
if (!response.ok) {
  response = await fetch(tokenUrl + '?grant_type=...&code=...&client_id=...', {
    method: 'GET'
  });
}
```

### ä¸ºä»€ä¹ˆéœ€è¦ä¸‰ç§æ–¹å¼

ä¸åŒçš„CASæœåŠ¡å™¨å®ç°å¯èƒ½è¦æ±‚ä¸åŒçš„OAuthè¯·æ±‚æ ¼å¼ï¼š

| CASç‰ˆæœ¬ | æ¨èæ–¹å¼ | è¯´æ˜ |
|---------|---------|------|
| CAS 6.x+ | Basic Auth | ç¬¦åˆOAuth 2.0æ ‡å‡† |
| CAS 5.x | POST + body | å¸¸è§å®ç°æ–¹å¼ |
| CAS 4.xåŠæ›´æ—© | GET + URL | æ—§ç‰ˆå®ç° |

æˆ‘ä»¬çš„æ™ºèƒ½é‡è¯•æœºåˆ¶ä¼šè‡ªåŠ¨æ‰¾åˆ°æ­£ç¡®çš„æ–¹å¼ã€‚

## éªŒè¯æ¸…å•

- [ ] æ‰§è¡Œäº†`./redeploy-edge-function.sh`
- [ ] æµ‹è¯•è„šæœ¬ä¸å†è¿”å›`invalid_request`
- [ ] å¯ä»¥è®¿é—®ç½‘ç«™
- [ ] å¯ä»¥ç‚¹å‡»ç™»å½•å¹¶è·³è½¬åˆ°CAS
- [ ] è¾“å…¥è´¦å·å¯†ç åèƒ½è¿”å›ç½‘ç«™
- [ ] ç™»å½•æˆåŠŸï¼ŒHeaderæ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯

## è¯¦ç»†æ–‡æ¡£

- ğŸ“„ **OAuthè¯·æ±‚ä¿®å¤è®°å½•.md** - å®Œæ•´çš„ä¿®æ”¹å†å²å’ŒæŠ€æœ¯ç»†èŠ‚
- ğŸ“„ **è§£å†³500é”™è¯¯.md** - 500é”™è¯¯çš„è¯¦ç»†è§£å†³æ–¹æ¡ˆ
- ğŸ“„ **ä¿®å¤401é”™è¯¯æŒ‡å—.md** - 401é”™è¯¯çš„è§£å†³æ–¹æ¡ˆ

## éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœé‡æ–°éƒ¨ç½²åä»ç„¶å¤±è´¥ï¼Œè¯·æŸ¥çœ‹ï¼š

```bash
# æŸ¥çœ‹Edge Functionæ—¥å¿—
supabase functions logs oauth-callback --limit 50

# æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£
cat OAuthè¯·æ±‚ä¿®å¤è®°å½•.md
```

---

**å…³é”®ç‚¹**ï¼š
- âœ… ä»£ç å·²ä¿®å¤
- âš ï¸ éœ€è¦é‡æ–°éƒ¨ç½²Edge Function
- âš ï¸ æ‰§è¡Œï¼š`./redeploy-edge-function.sh`
