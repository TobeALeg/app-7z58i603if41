# å¿«é€Ÿä¿®å¤æŒ‡å—

## å½“å‰é—®é¢˜

Edge Functionè¿”å›500é”™è¯¯ï¼š`error=invalid_request`

## å·²ä¿®å¤å†…å®¹

âœ… **OAuth tokenè¯·æ±‚å‚æ•°ä½ç½®å·²ä¿®æ­£**

- ä¿®æ”¹æ–‡ä»¶ï¼š`supabase/functions/oauth-callback/index.ts`
- ä¿®æ”¹ä½ç½®ï¼šç¬¬66-90è¡Œ
- å…³é”®ä¿®æ”¹ï¼šå°†å‚æ•°ä»URLç§»åˆ°è¯·æ±‚ä½“ä¸­

## ç«‹å³æ‰§è¡Œ

### 1. é‡æ–°éƒ¨ç½²Edge Function

```bash
cd ~/projects/app-7z58i603if41
./redeploy-edge-function.sh
```

### 2. æµ‹è¯•ä¿®å¤ç»“æœ

```bash
./check-supabase.sh
```

**é¢„æœŸç»“æœ**ï¼š
- âŒ ä¹‹å‰ï¼š`error=invalid_request`
- âœ… ç°åœ¨ï¼š`error=invalid_grant`ï¼ˆtest codeæ— æ•ˆï¼Œæ­£å¸¸ï¼‰

### 3. æµ‹è¯•çœŸå®ç™»å½•

1. è®¿é—® https://aigctmp.wzbc.edu.cn
2. ç‚¹å‡»"ç™»å½•"
3. è¾“å…¥å­¦å·å’Œå¯†ç 
4. åº”è¯¥èƒ½æˆåŠŸç™»å½•

### 4. æŸ¥çœ‹å®æ—¶æ—¥å¿—ï¼ˆå¯é€‰ï¼‰

```bash
supabase functions logs oauth-callback --follow
```

## ä¿®æ”¹è¯¦æƒ…

### ä¿®æ”¹å‰ï¼ˆé”™è¯¯ï¼‰âŒ

```typescript
// å‚æ•°åœ¨URLä¸­ï¼Œè¯·æ±‚ä½“ä¸ºç©º
const tokenUrl = `${OAUTH_CONFIG.tokenUrl}?${tokenParams.toString()}`;
const tokenResponse = await fetch(tokenUrl, {
  method: 'POST',
  headers: {
    'Accept': 'application/json',
    'Content-Type': 'application/x-www-form-urlencoded',
  },
  // æ²¡æœ‰body
});
```

### ä¿®æ”¹åï¼ˆæ­£ç¡®ï¼‰âœ…

```typescript
// å‚æ•°åœ¨è¯·æ±‚ä½“ä¸­
const tokenResponse = await fetch(OAUTH_CONFIG.tokenUrl, {
  method: 'POST',
  headers: {
    'Accept': 'application/json',
    'Content-Type': 'application/x-www-form-urlencoded',
  },
  body: tokenParams.toString(),  // âœ… å‚æ•°åœ¨è¿™é‡Œ
});
```

## ä¸ºä»€ä¹ˆè¿™æ ·ä¿®æ”¹

æ ¹æ®**OAuth 2.0 RFC 6749æ ‡å‡†**å’Œ**CAS OAuth 2.0åè®®**ï¼š

- âœ… Token endpointå¿…é¡»ä½¿ç”¨POSTæ–¹æ³•
- âœ… å‚æ•°å¿…é¡»åœ¨è¯·æ±‚ä½“ä¸­ï¼ˆä¸æ˜¯URLå‚æ•°ï¼‰
- âœ… Content-Typeå¿…é¡»æ˜¯`application/x-www-form-urlencoded`

## éªŒè¯æ¸…å•

- [ ] æ‰§è¡Œäº†`./redeploy-edge-function.sh`
- [ ] æµ‹è¯•è„šæœ¬ä¸å†è¿”å›`invalid_request`
- [ ] å¯ä»¥è®¿é—®ç½‘ç«™
- [ ] å¯ä»¥ç‚¹å‡»ç™»å½•å¹¶è·³è½¬åˆ°CAS
- [ ] è¾“å…¥è´¦å·å¯†ç åèƒ½è¿”å›ç½‘ç«™
- [ ] ç™»å½•æˆåŠŸï¼ŒHeaderæ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯

## è¯¦ç»†æ–‡æ¡£

- ğŸ“„ **OAuthè¯·æ±‚ä¿®å¤è®°å½•.md** - å®Œæ•´çš„ä¿®æ”¹å†å²å’ŒæŠ€æœ¯ç»†èŠ‚
- ğŸ“„ **è§£å†³500é”™è¯¯.md** - 500é”™è¯¯çš„è¯¦ç»†è§£å†³æ–¹æ¡ˆ
- ğŸ“„ **ä¿®å¤401é”™è¯¯æŒ‡å—.md** - 401é”™è¯¯çš„è§£å†³æ–¹æ¡ˆ

## éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœé‡æ–°éƒ¨ç½²åä»ç„¶å¤±è´¥ï¼Œè¯·æŸ¥çœ‹ï¼š

```bash
# æŸ¥çœ‹Edge Functionæ—¥å¿—
supabase functions logs oauth-callback --limit 50

# æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£
cat OAuthè¯·æ±‚ä¿®å¤è®°å½•.md
```

---

**å…³é”®ç‚¹**ï¼š
- âœ… ä»£ç å·²ä¿®å¤
- âš ï¸ éœ€è¦é‡æ–°éƒ¨ç½²Edge Function
- âš ï¸ æ‰§è¡Œï¼š`./redeploy-edge-function.sh`
