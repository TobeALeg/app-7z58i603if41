# ğŸ”§ CASç™»å½•é—®é¢˜è§£å†³æ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜æ€»ç»“

### é—®é¢˜1: æµè§ˆå™¨æ˜¾ç¤º"ä¸å®‰å…¨" âš ï¸

**ç°è±¡**: è®¿é—® https://aigctmp.wzbc.edu.cn æ—¶ï¼Œæµè§ˆå™¨æ˜¾ç¤º"ä¸å®‰å…¨"è­¦å‘Š

**å¯èƒ½åŸå› **:
1. SSLè¯ä¹¦åŸŸåä¸åŒ¹é…ï¼ˆæœ€å¯èƒ½ï¼‰
2. è¯ä¹¦é“¾ä¸å®Œæ•´
3. è¯ä¹¦è¿‡æœŸ

**æ£€æŸ¥æ–¹æ³•**:
```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
cd /home/lw/projects/app-7z58i603if41/apache
./check-ssl.sh
```

æˆ–æ‰‹åŠ¨æ£€æŸ¥ï¼š
```bash
openssl x509 -in wzbc-edu-cn-1024225915.crt -text -noout | grep -E "(Subject:|DNS:)"
```

**è§£å†³æ–¹æ¡ˆ**: è¯·æŸ¥çœ‹ `é—®é¢˜æ’æŸ¥ä¸è§£å†³.md` æ–‡æ¡£

---

### é—®é¢˜2: CASç™»å½•åè¿”å›æœªç™»å½•çŠ¶æ€ âœ… å·²ä¿®å¤

**ç°è±¡**: ç‚¹å‡»"ç»Ÿä¸€èº«ä»½è®¤è¯"ï¼ŒæˆåŠŸè¾“å…¥è´¦å·å¯†ç åè¿”å›é¡¹ç›®ç•Œé¢ä»æ˜¾ç¤ºæœªç™»å½•

**æ ¹æœ¬åŸå› **: Edge Functionæœªéƒ¨ç½²åˆ°Supabaseäº‘ç«¯

**å·²ä¿®å¤å†…å®¹**:
1. âœ… ä¿®æ”¹äº†å‰ç«¯OAuthå›è°ƒå¤„ç†é€»è¾‘
2. âœ… æ›´æ–°äº†Edge Functionä»£ç 
3. âœ… æ·»åŠ äº†CORSæ”¯æŒ
4. âœ… åˆ›å»ºäº†è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬

---

## ğŸš€ è§£å†³æ­¥éª¤

### å¿«é€Ÿè§£å†³ï¼ˆæ¨èï¼‰

**ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬**:

```bash
# åœ¨é¡¹ç›®ç›®å½•æ‰§è¡Œ
cd ~/projects/app-7z58i603if41

# è¿è¡Œå®Œæ•´éƒ¨ç½²è„šæœ¬
./deploy-with-edge-function.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨å®Œæˆï¼š
1. æ£€æŸ¥å¹¶å®‰è£…Supabase CLI
2. ç™»å½•Supabaseè´¦å·
3. å…³è”é¡¹ç›®
4. éƒ¨ç½²Edge Function
5. æ„å»ºå‰ç«¯
6. éƒ¨ç½²åˆ°æœåŠ¡å™¨

---

### æ‰‹åŠ¨è§£å†³ï¼ˆè¯¦ç»†æ­¥éª¤ï¼‰

#### ç¬¬1æ­¥ï¼šå®‰è£…Supabase CLI

```bash
# å…¨å±€å®‰è£…
npm install -g supabase

# éªŒè¯å®‰è£…
supabase --version
```

#### ç¬¬2æ­¥ï¼šç™»å½•Supabase

```bash
# ç™»å½•ï¼ˆä¼šæ‰“å¼€æµè§ˆå™¨ï¼‰
supabase login

# éªŒè¯ç™»å½•çŠ¶æ€
supabase projects list
```

#### ç¬¬3æ­¥ï¼šå…³è”é¡¹ç›®

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd ~/projects/app-7z58i603if41

# å…³è”é¡¹ç›®
supabase link --project-ref supabase254442544895672320
```

#### ç¬¬4æ­¥ï¼šéƒ¨ç½²Edge Function

```bash
# éƒ¨ç½²oauth-callbackå‡½æ•°
supabase functions deploy oauth-callback

# ç­‰å¾…éƒ¨ç½²å®Œæˆ
# æˆåŠŸåä¼šæ˜¾ç¤ºå‡½æ•°URL
```

#### ç¬¬5æ­¥ï¼šé…ç½®ç¯å¢ƒå˜é‡

åœ¨Supabaseæ§åˆ¶å°é…ç½®ï¼š

1. è®¿é—® https://supabase.com
2. è¿›å…¥é¡¹ç›®
3. ç‚¹å‡» Edge Functions â†’ oauth-callback
4. æ·»åŠ ç¯å¢ƒå˜é‡ï¼š

```
OAUTH_TOKEN_URL=https://cas.wzbc.edu.cn/cas/oauth2.0/accessToken
OAUTH_USERINFO_URL=https://cas.wzbc.edu.cn/cas/oauth2.0/profile
OAUTH_CLIENT_ID=CijBwB5EwTTXouO7
OAUTH_CLIENT_SECRET=O8dOsXE7p7yMbh18KEP2Z6
OAUTH_REDIRECT_URI=https://aigctmp.wzbc.edu.cn/auth/callback
```

#### ç¬¬6æ­¥ï¼šé‡æ–°æ„å»ºå¹¶éƒ¨ç½²å‰ç«¯

```bash
# æ„å»º
npm run build

# éƒ¨ç½²
./deploy.sh
```

#### ç¬¬7æ­¥ï¼šæµ‹è¯•ç™»å½•

1. è®¿é—® https://aigctmp.wzbc.edu.cn
2. ç‚¹å‡»"ç™»å½•"
3. è¾“å…¥å­¦å·å’Œå¯†ç 
4. æ£€æŸ¥æ˜¯å¦æˆåŠŸç™»å½•

---

## ğŸ” éªŒè¯ç™»å½•æ˜¯å¦æˆåŠŸ

### æ–¹æ³•1: æŸ¥çœ‹Header

ç™»å½•æˆåŠŸåï¼ŒHeaderå³ä¸Šè§’åº”è¯¥æ˜¾ç¤ºï¼š
- ç”¨æˆ·å§“å
- "é€€å‡º"æŒ‰é’®

### æ–¹æ³•2: æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°

1. æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·
2. åˆ‡æ¢åˆ° Console æ ‡ç­¾
3. åº”è¯¥çœ‹åˆ°ï¼š
   ```
   æ”¶åˆ°æˆæƒç ï¼Œå¼€å§‹æ¢å–access_token...
   æˆåŠŸè·å–access_tokenï¼Œå¼€å§‹è·å–ç”¨æˆ·ä¿¡æ¯...
   æˆåŠŸè·å–ç”¨æˆ·ä¿¡æ¯: {...}
   ç™»å½•æˆåŠŸï¼æ­£åœ¨è·³è½¬...
   ```

### æ–¹æ³•3: æŸ¥çœ‹Edge Functionæ—¥å¿—

```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿—
supabase functions logs oauth-callback --follow

# åº”è¯¥çœ‹åˆ°ï¼š
# æ”¶åˆ°æˆæƒç ï¼Œå¼€å§‹æ¢å–access_token...
# æˆåŠŸè·å–access_tokenï¼Œå¼€å§‹è·å–ç”¨æˆ·ä¿¡æ¯...
# æˆåŠŸè·å–ç”¨æˆ·ä¿¡æ¯: {...}
```

---

## âŒ å¸¸è§é”™è¯¯åŠè§£å†³

### é”™è¯¯1: "Edge Functionè°ƒç”¨å¤±è´¥"

**åŸå› **: Edge Functionæœªéƒ¨ç½²æˆ–éƒ¨ç½²å¤±è´¥

**è§£å†³**:
```bash
# é‡æ–°éƒ¨ç½²
supabase functions deploy oauth-callback

# æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€
supabase functions list
```

### é”™è¯¯2: "è·å–access_tokenå¤±è´¥"

**åŸå› **: OAuthé…ç½®é”™è¯¯

**æ£€æŸ¥**:
1. OAUTH_CLIENT_IDæ˜¯å¦æ­£ç¡®
2. OAUTH_CLIENT_SECRETæ˜¯å¦æ­£ç¡®
3. OAUTH_REDIRECT_URIæ˜¯å¦æ­£ç¡®

**è§£å†³**: åœ¨Supabaseæ§åˆ¶å°æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®

### é”™è¯¯3: "æœªèƒ½è·å–ç”¨æˆ·ä¿¡æ¯"

**åŸå› **: CASç³»ç»Ÿè¿”å›æ•°æ®æ ¼å¼ä¸ç¬¦åˆé¢„æœŸ

**è§£å†³**:
```bash
# æŸ¥çœ‹Edge Functionæ—¥å¿—
supabase functions logs oauth-callback --follow

# æŸ¥çœ‹è¿”å›çš„ç”¨æˆ·ä¿¡æ¯æ ¼å¼
# æ ¹æ®å®é™…æ ¼å¼è°ƒæ•´ä»£ç 
```

### é”™è¯¯4: "CORSé”™è¯¯"

**åŸå› **: Edge Functionæœªæ­£ç¡®é…ç½®CORS

**è§£å†³**: Edge Functionä»£ç å·²æ›´æ–°ï¼ŒåŒ…å«CORSå¤´ï¼Œé‡æ–°éƒ¨ç½²å³å¯

### é”™è¯¯5: "supabaseå‘½ä»¤ä¸å­˜åœ¨"

**åŸå› **: Supabase CLIæœªå®‰è£…æˆ–æœªæ·»åŠ åˆ°PATH

**è§£å†³**:
```bash
# é‡æ–°å®‰è£…
npm install -g supabase

# æˆ–ä½¿ç”¨npx
npx supabase --version
```

---

## ğŸ“Š ç™»å½•æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·ç‚¹å‡»ç™»å½•   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è·³è½¬åˆ°CASè®¤è¯é¡µ  â”‚
â”‚ cas.wzbc.edu.cn â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CASè®¤è¯æˆåŠŸ     â”‚
â”‚  è¿”å›æˆæƒç code  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å›è°ƒåˆ°å‰ç«¯               â”‚
â”‚ /auth/callback?code=xxx â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯è°ƒç”¨Edge Function    â”‚
â”‚ supabase.functions.      â”‚
â”‚   invoke('oauth-callback')â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Edge Functionå¤„ç†        â”‚
â”‚ 1. ç”¨codeæ¢access_token  â”‚
â”‚ 2. ç”¨tokenè·å–ç”¨æˆ·ä¿¡æ¯   â”‚
â”‚ 3. è¿”å›ç”¨æˆ·ä¿¡æ¯          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯åˆ›å»ºSupabaseä¼šè¯     â”‚
â”‚ supabase.auth.           â”‚
â”‚   signInWithPassword()   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç™»å½•æˆåŠŸï¼     â”‚
â”‚  æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ éƒ¨ç½²æ£€æŸ¥æ¸…å•

### Supabaseé…ç½®
- [ ] Supabase CLIå·²å®‰è£…
- [ ] å·²ç™»å½•Supabaseè´¦å·
- [ ] é¡¹ç›®å·²å…³è”
- [ ] Edge Functionå·²éƒ¨ç½²
- [ ] ç¯å¢ƒå˜é‡å·²é…ç½®

### å‰ç«¯é…ç½®
- [ ] .envæ–‡ä»¶é…ç½®æ­£ç¡®
- [ ] é¡¹ç›®å·²é‡æ–°æ„å»º
- [ ] å·²éƒ¨ç½²åˆ°æœåŠ¡å™¨
- [ ] Apacheå·²é‡å¯

### åŠŸèƒ½æµ‹è¯•
- [ ] å¯ä»¥è®¿é—®ç½‘ç«™
- [ ] ç‚¹å‡»ç™»å½•è·³è½¬åˆ°CAS
- [ ] è¾“å…¥è´¦å·å¯†ç æˆåŠŸ
- [ ] å›è°ƒåˆ°ç½‘ç«™
- [ ] æ˜¾ç¤ºç™»å½•çŠ¶æ€
- [ ] Headeræ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯

---

## ğŸ¯ å¿«é€Ÿå‘½ä»¤å‚è€ƒ

```bash
# === Supabase CLI ===
# å®‰è£…
npm install -g supabase

# ç™»å½•
supabase login

# å…³è”é¡¹ç›®
supabase link --project-ref supabase254442544895672320

# éƒ¨ç½²Edge Function
supabase functions deploy oauth-callback

# æŸ¥çœ‹æ—¥å¿—
supabase functions logs oauth-callback --follow

# æŸ¥çœ‹å‡½æ•°åˆ—è¡¨
supabase functions list

# === å‰ç«¯éƒ¨ç½² ===
# æ„å»º
npm run build

# éƒ¨ç½²ï¼ˆè‡ªåŠ¨åŒ–ï¼‰
./deploy.sh

# éƒ¨ç½²ï¼ˆæ‰‹åŠ¨ï¼‰
rsync -avz --delete dist/ lw@10.145.251.29:/var/www/aigctmp/

# === æµ‹è¯• ===
# è®¿é—®ç½‘ç«™
https://aigctmp.wzbc.edu.cn

# æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°
F12 â†’ Console

# æŸ¥çœ‹Apacheæ—¥å¿—
ssh lw@10.145.251.29
sudo tail -f /var/log/apache2/aigctmp_error.log
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **CASç™»å½•é…ç½®æŒ‡å—.md** - è¯¦ç»†çš„é…ç½®æ­¥éª¤
- **é—®é¢˜æ’æŸ¥ä¸è§£å†³.md** - SSLè¯ä¹¦é—®é¢˜æ’æŸ¥
- **å®Œæ•´éƒ¨ç½²æµç¨‹.md** - å®Œæ•´çš„éƒ¨ç½²æ–‡æ¡£
- **åŸŸåé…ç½®æŒ‡å—.md** - åŸŸåé…ç½®è¯´æ˜

---

## ğŸ’¡ é‡è¦æç¤º

### å…³äºEdge Function

Edge Functionæ˜¯Supabaseæä¾›çš„æ— æœåŠ¡å™¨å‡½æ•°æœåŠ¡ï¼Œç±»ä¼¼äºAWS Lambdaæˆ–Cloudflare Workersã€‚

**ç‰¹ç‚¹**:
- è¿è¡Œåœ¨äº‘ç«¯
- è‡ªåŠ¨æ‰©å±•
- æŒ‰ä½¿ç”¨é‡è®¡è´¹ï¼ˆå…è´¹é¢åº¦å……è¶³ï¼‰
- æ”¯æŒDenoè¿è¡Œæ—¶

**ä¸ºä»€ä¹ˆéœ€è¦Edge Function**:
1. å¤„ç†OAuthå›è°ƒéœ€è¦æœåŠ¡å™¨ç«¯ä»£ç 
2. ä¿æŠ¤OAuthå®¢æˆ·ç«¯å¯†é’¥ï¼ˆä¸èƒ½æš´éœ²åœ¨å‰ç«¯ï¼‰
3. ä¸CASç³»ç»Ÿäº¤äº’éœ€è¦æœåŠ¡å™¨ç«¯è¯·æ±‚

### å…³äºSupabaseå…è´¹é¢åº¦

Supabaseæä¾›æ…·æ…¨çš„å…è´¹é¢åº¦ï¼š
- Edge Function: 500,000æ¬¡è°ƒç”¨/æœˆ
- æ•°æ®åº“: 500MBå­˜å‚¨
- è®¤è¯: 50,000ä¸ªæ´»è·ƒç”¨æˆ·

å¯¹äºå­¦æ ¡é¡¹ç›®æ¥è¯´ï¼Œå…è´¹é¢åº¦å®Œå…¨å¤Ÿç”¨ï¼

---

## âœ… æˆåŠŸæ ‡å¿—

éƒ¨ç½²æˆåŠŸåï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿï¼š

1. âœ… è®¿é—® https://aigctmp.wzbc.edu.cn
2. âœ… ç‚¹å‡»"ç™»å½•"æŒ‰é’®
3. âœ… è·³è½¬åˆ°CASè®¤è¯é¡µé¢
4. âœ… è¾“å…¥å­¦å·å’Œå¯†ç 
5. âœ… æˆåŠŸç™»å½•å¹¶è¿”å›ç½‘ç«™
6. âœ… Headeræ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯ï¼ˆå§“åï¼‰
7. âœ… å¯ä»¥è®¿é—®éœ€è¦ç™»å½•çš„é¡µé¢
8. âœ… å¯ä»¥æäº¤æŠ¥åä¿¡æ¯
9. âœ… å¯ä»¥ä¸Šä¼ ä½œå“

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœæŒ‰ç…§æœ¬æ–‡æ¡£æ“ä½œåä»ç„¶æ— æ³•ç™»å½•ï¼Œè¯·ï¼š

1. **æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°**ï¼ˆF12 â†’ Consoleï¼‰
2. **æŸ¥çœ‹Edge Functionæ—¥å¿—**ï¼ˆ`supabase functions logs oauth-callback`ï¼‰
3. **æŸ¥çœ‹Apacheæ—¥å¿—**ï¼ˆ`sudo tail -f /var/log/apache2/aigctmp_error.log`ï¼‰
4. **æä¾›é”™è¯¯ä¿¡æ¯**ä»¥ä¾¿è¿›ä¸€æ­¥è¯Šæ–­

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æ›´æ–°æ—¥æœŸ**: 2025-12-03  
**çŠ¶æ€**: å·²ä¿®å¤ï¼Œå¾…éƒ¨ç½²æµ‹è¯•
