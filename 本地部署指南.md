# æœ¬åœ°éƒ¨ç½²æŒ‡å—

æœ¬æ–‡æ¡£æä¾›æ™ºèƒ½ä½“æ¯”èµ›æŠ¥åå¹³å°çš„è¯¦ç»†éƒ¨ç½²æ­¥éª¤ï¼ŒåŒ…å«ä¸¤ç§éƒ¨ç½²æ–¹æ¡ˆã€‚

---

## ğŸ“‹ æ–¹æ¡ˆé€‰æ‹©

### æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨Supabaseäº‘æœåŠ¡ï¼ˆæ¨èï¼‰â­

**ä¼˜ç‚¹**ï¼š
- âœ… åŠŸèƒ½å®Œæ•´ï¼Œæ”¯æŒåœ¨çº¿æŠ¥åå’Œä½œå“æäº¤
- âœ… éƒ¨ç½²ç®€å•ï¼Œ5åˆ†é’Ÿå®Œæˆ
- âœ… æ— éœ€é…ç½®æ•°æ®åº“
- âœ… è‡ªåŠ¨æ‰©å±•ï¼Œæ€§èƒ½ç¨³å®š
- âœ… å…è´¹é¢åº¦å……è¶³ï¼ˆ500,000æ¬¡è°ƒç”¨/æœˆï¼‰

**ç¼ºç‚¹**ï¼š
- âš ï¸ ä¾èµ–äº‘æœåŠ¡ï¼ˆéœ€è¦ç½‘ç»œè¿æ¥ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šå¤§å¤šæ•°æƒ…å†µä¸‹æ¨èä½¿ç”¨

---

### æ–¹æ¡ˆäºŒï¼šå®Œå…¨æœ¬åœ°éƒ¨ç½²

**ä¼˜ç‚¹**ï¼š
- âœ… å®Œå…¨æœ¬åœ°åŒ–ï¼Œæ— äº‘æœåŠ¡ä¾èµ–
- âœ… æ•°æ®å®Œå…¨æŒæ§

**ç¼ºç‚¹**ï¼š
- âš ï¸ éœ€è¦é…ç½®æœ¬åœ°æ•°æ®åº“
- âš ï¸ éœ€è¦å¼€å‘æœ¬åœ°åç«¯API
- âš ï¸ é…ç½®å¤æ‚ï¼Œéœ€è¦1-2å¤©æ—¶é—´

**é€‚ç”¨åœºæ™¯**ï¼šæœ‰ç‰¹æ®Šå®‰å…¨è¦æ±‚æˆ–æ— æ³•ä½¿ç”¨äº‘æœåŠ¡æ—¶

---

## ğŸš€ æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨Supabaseäº‘æœåŠ¡ï¼ˆæ¨èï¼‰

### å‰ç½®è¦æ±‚

- âœ… Node.js >= 18.0.0
- âœ… npm æˆ– pnpm
- âœ… Git
- âœ… æœåŠ¡å™¨SSHè®¿é—®æƒé™
- âœ… Supabaseè´¦å·ï¼ˆå…è´¹æ³¨å†Œï¼‰

---

### ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡Supabaseé¡¹ç›®

#### 1.1 æ³¨å†ŒSupabaseè´¦å·

è®¿é—® https://supabase.com æ³¨å†Œå…è´¹è´¦å·

#### 1.2 è·å–é¡¹ç›®ä¿¡æ¯

é¡¹ç›®å·²é…ç½®å¥½Supabaseï¼Œä» `.env` æ–‡ä»¶ä¸­å¯ä»¥çœ‹åˆ°ï¼š

```bash
VITE_SUPABASE_URL=https://backend.appmiaoda.com/projects/supabase254442544895672320
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**é¡¹ç›®å¼•ç”¨ID**: `supabase254442544895672320`

---

### ç¬¬äºŒæ­¥ï¼šéƒ¨ç½²Edge Function

Edge Functionç”¨äºå¤„ç†CAS OAuthè®¤è¯å›è°ƒï¼Œå¿…é¡»éƒ¨ç½²æ‰èƒ½ä½¿ç”¨ç™»å½•åŠŸèƒ½ã€‚

#### 2.1 å®‰è£…Supabase CLI

```bash
# å…¨å±€å®‰è£…
npm install -g supabase

# éªŒè¯å®‰è£…
supabase --version
```

#### 2.2 ç™»å½•Supabase

```bash
# ç™»å½•ï¼ˆä¼šæ‰“å¼€æµè§ˆå™¨ï¼‰
supabase login

# éªŒè¯ç™»å½•çŠ¶æ€
supabase projects list
```

#### 2.3 å…³è”é¡¹ç›®

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd ~/projects/app-7z58i603if41

# å…³è”é¡¹ç›®
supabase link --project-ref supabase254442544895672320
```

#### 2.4 éƒ¨ç½²Edge Function

```bash
# éƒ¨ç½²oauth-callbackå‡½æ•°
supabase functions deploy oauth-callback

# ç­‰å¾…éƒ¨ç½²å®Œæˆï¼ˆçº¦30ç§’ï¼‰
# æˆåŠŸåä¼šæ˜¾ç¤ºå‡½æ•°URL
```

#### 2.5 é…ç½®Edge Functionç¯å¢ƒå˜é‡

**é‡è¦**ï¼šå¿…é¡»é…ç½®ç¯å¢ƒå˜é‡ï¼Œå¦åˆ™ç™»å½•åŠŸèƒ½æ— æ³•æ­£å¸¸å·¥ä½œã€‚

1. è®¿é—® https://supabase.com
2. è¿›å…¥é¡¹ç›®
3. ç‚¹å‡»å·¦ä¾§èœå• **Edge Functions**
4. ç‚¹å‡» **oauth-callback** å‡½æ•°
5. ç‚¹å‡» **Settings** æ ‡ç­¾
6. ç‚¹å‡» **Secrets** å­æ ‡ç­¾
7. æ·»åŠ ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š

```bash
OAUTH_TOKEN_URL=https://cas.wzbc.edu.cn/cas/oauth2.0/accessToken
OAUTH_USERINFO_URL=https://cas.wzbc.edu.cn/cas/oauth2.0/profile
OAUTH_CLIENT_ID=CijBwB5EwTTXouO7
OAUTH_CLIENT_SECRET=O8dOsXE7p7yMbh18KEP2Z6
OAUTH_REDIRECT_URI=https://aigctmp.wzbc.edu.cn/auth/callback
```

---

### ç¬¬ä¸‰æ­¥ï¼šæ„å»ºå‰ç«¯é¡¹ç›®

#### 3.1 å®‰è£…ä¾èµ–

```bash
cd ~/projects/app-7z58i603if41
npm install
```

#### 3.2 éªŒè¯ç¯å¢ƒå˜é‡

ç¡®ä¿ `.env` æ–‡ä»¶å­˜åœ¨ä¸”é…ç½®æ­£ç¡®ï¼š

```bash
cat .env
```

åº”è¯¥åŒ…å«ï¼š

```bash
VITE_APP_ID=app-7z58i603if41
VITE_SUPABASE_URL=https://backend.appmiaoda.com/projects/supabase254442544895672320
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

#### 3.3 æ„å»ºé¡¹ç›®

```bash
npm run build
```

æ„å»ºæˆåŠŸåï¼Œä¼šåœ¨ `dist/` ç›®å½•ç”Ÿæˆé™æ€æ–‡ä»¶ã€‚

---

### ç¬¬å››æ­¥ï¼šé…ç½®æœåŠ¡å™¨

#### 4.1 å®‰è£…Apache

```bash
# æ›´æ–°è½¯ä»¶åŒ…
sudo apt update

# å®‰è£…Apache
sudo apt install apache2

# å¯åŠ¨Apache
sudo systemctl start apache2
sudo systemctl enable apache2

# éªŒè¯Apacheè¿è¡Œ
sudo systemctl status apache2
```

#### 4.2 å¯ç”¨å¿…è¦çš„Apacheæ¨¡å—

```bash
sudo a2enmod rewrite
sudo a2enmod ssl
sudo a2enmod headers
sudo systemctl restart apache2
```

#### 4.3 åˆ›å»ºç½‘ç«™ç›®å½•

```bash
sudo mkdir -p /var/www/aigctmp
sudo chown -R www-data:www-data /var/www/aigctmp
sudo chmod -R 755 /var/www/aigctmp
```

#### 4.4 é…ç½®è™šæ‹Ÿä¸»æœº

åˆ›å»ºApacheé…ç½®æ–‡ä»¶ï¼š

```bash
sudo nano /etc/apache2/sites-available/aigctmp.conf
```

æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```apache
<VirtualHost *:80>
    ServerName aigctmp.wzbc.edu.cn
    DocumentRoot /var/www/aigctmp

    # é‡å®šå‘åˆ°HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
</VirtualHost>

<VirtualHost *:443>
    ServerName aigctmp.wzbc.edu.cn
    DocumentRoot /var/www/aigctmp

    # SSLé…ç½®
    SSLEngine on
    SSLCertificateFile /home/lw/projects/app-7z58i603if41/apache/wzbc-edu-cn-1024225915.crt
    SSLCertificateKeyFile /home/lw/projects/app-7z58i603if41/apache/wzbc-edu-cn-1024225915.key
    SSLCertificateChainFile /home/lw/projects/app-7z58i603if41/apache/wzbc-edu-cn-1024225915_chain.crt

    # ç›®å½•é…ç½®
    <Directory /var/www/aigctmp>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted

        # React Routeræ”¯æŒ
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>

    # æ—¥å¿—é…ç½®
    ErrorLog ${APACHE_LOG_DIR}/aigctmp_error.log
    CustomLog ${APACHE_LOG_DIR}/aigctmp_access.log combined
</VirtualHost>
```

#### 4.5 å¯ç”¨ç«™ç‚¹

```bash
# å¯ç”¨ç«™ç‚¹
sudo a2ensite aigctmp.conf

# ç¦ç”¨é»˜è®¤ç«™ç‚¹ï¼ˆå¯é€‰ï¼‰
sudo a2dissite 000-default.conf

# æµ‹è¯•é…ç½®
sudo apache2ctl configtest

# å¦‚æœæ˜¾ç¤º"Syntax OK"ï¼Œé‡å¯Apache
sudo systemctl restart apache2
```

---

### ç¬¬äº”æ­¥ï¼šéƒ¨ç½²åˆ°æœåŠ¡å™¨

#### 5.1 ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬ï¼ˆæ¨èï¼‰

é¡¹ç›®åŒ…å«è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬ï¼š

```bash
# åœ¨é¡¹ç›®ç›®å½•æ‰§è¡Œ
./deploy.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
1. æ„å»ºé¡¹ç›®
2. ä¸Šä¼ åˆ°æœåŠ¡å™¨
3. è®¾ç½®æƒé™
4. é‡å¯Apache

#### 5.2 æ‰‹åŠ¨éƒ¨ç½²

å¦‚æœè‡ªåŠ¨åŒ–è„šæœ¬å¤±è´¥ï¼Œå¯ä»¥æ‰‹åŠ¨éƒ¨ç½²ï¼š

```bash
# 1. æ„å»ºé¡¹ç›®
npm run build

# 2. ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨
rsync -avz --delete dist/ lw@10.145.251.29:/var/www/aigctmp/

# 3. ç™»å½•æœåŠ¡å™¨
ssh lw@10.145.251.29

# 4. è®¾ç½®æƒé™
sudo chown -R www-data:www-data /var/www/aigctmp
sudo chmod -R 755 /var/www/aigctmp

# 5. é‡å¯Apache
sudo systemctl restart apache2
```

---

### ç¬¬å…­æ­¥ï¼šæµ‹è¯•éƒ¨ç½²

#### 6.1 è®¿é—®ç½‘ç«™

æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼šhttps://aigctmp.wzbc.edu.cn

åº”è¯¥èƒ½çœ‹åˆ°é¦–é¡µã€‚

#### 6.2 æµ‹è¯•ç™»å½•åŠŸèƒ½

1. ç‚¹å‡»å³ä¸Šè§’"ç™»å½•"æŒ‰é’®
2. é€‰æ‹©"ç»Ÿä¸€èº«ä»½è®¤è¯"
3. è¾“å…¥å­¦å·å’Œå¯†ç 
4. ç™»å½•æˆåŠŸåï¼ŒHeaderåº”è¯¥æ˜¾ç¤ºç”¨æˆ·å§“å
5. ç‚¹å‡»"é€€å‡º"å¯ä»¥é€€å‡ºç™»å½•

#### 6.3 æµ‹è¯•æŠ¥ååŠŸèƒ½

1. ç™»å½•åï¼Œç‚¹å‡»"ç«‹å³æŠ¥å"
2. å¡«å†™æŠ¥åä¿¡æ¯
3. æäº¤æŠ¥å
4. åœ¨"æˆ‘çš„æŠ¥å"é¡µé¢æŸ¥çœ‹æŠ¥åçŠ¶æ€

#### 6.4 æŸ¥çœ‹æ—¥å¿—

å¦‚æœé‡åˆ°é—®é¢˜ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š

```bash
# æµè§ˆå™¨æ§åˆ¶å°
# æŒ‰F12æ‰“å¼€å¼€å‘è€…å·¥å…· â†’ Consoleæ ‡ç­¾

# Apacheé”™è¯¯æ—¥å¿—
sudo tail -f /var/log/apache2/aigctmp_error.log

# Edge Functionæ—¥å¿—
supabase functions logs oauth-callback --follow
```

---

### æ•…éšœæ’æŸ¥

#### é—®é¢˜1ï¼šç™»å½•åä»æ˜¾ç¤ºæœªç™»å½•

**åŸå› **ï¼šEdge Functionæœªéƒ¨ç½²æˆ–ç¯å¢ƒå˜é‡æœªé…ç½®

**è§£å†³æ­¥éª¤**ï¼š

1. æ£€æŸ¥Edge Functionæ˜¯å¦éƒ¨ç½²ï¼š
   ```bash
   supabase functions list
   ```

2. å¦‚æœæœªéƒ¨ç½²ï¼Œé‡æ–°éƒ¨ç½²ï¼š
   ```bash
   supabase functions deploy oauth-callback
   ```

3. æ£€æŸ¥ç¯å¢ƒå˜é‡æ˜¯å¦é…ç½®ï¼š
   - è®¿é—®Supabaseæ§åˆ¶å°
   - Edge Functions â†’ oauth-callback â†’ Settings â†’ Secrets
   - ç¡®è®¤æ‰€æœ‰ç¯å¢ƒå˜é‡éƒ½å·²æ·»åŠ 

4. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯ï¼š
   - æŒ‰F12æ‰“å¼€å¼€å‘è€…å·¥å…·
   - æŸ¥çœ‹Consoleæ ‡ç­¾çš„é”™è¯¯ä¿¡æ¯

5. æŸ¥çœ‹Edge Functionæ—¥å¿—ï¼š
   ```bash
   supabase functions logs oauth-callback --follow
   ```

#### é—®é¢˜2ï¼šé¡µé¢åˆ·æ–°å404

**åŸå› **ï¼šApacheæœªæ­£ç¡®é…ç½®React Routeræ”¯æŒ

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. æ£€æŸ¥Apacheé…ç½®æ–‡ä»¶æ˜¯å¦åŒ…å«Rewriteè§„åˆ™
2. ç¡®ä¿å·²å¯ç”¨rewriteæ¨¡å—ï¼š
   ```bash
   sudo a2enmod rewrite
   sudo systemctl restart apache2
   ```

3. åœ¨ç½‘ç«™æ ¹ç›®å½•åˆ›å»º `.htaccess` æ–‡ä»¶ï¼š
   ```bash
   sudo nano /var/www/aigctmp/.htaccess
   ```

   æ·»åŠ å†…å®¹ï¼š
   ```apache
   <IfModule mod_rewrite.c>
     RewriteEngine On
     RewriteBase /
     RewriteRule ^index\.html$ - [L]
     RewriteCond %{REQUEST_FILENAME} !-f
     RewriteCond %{REQUEST_FILENAME} !-d
     RewriteRule . /index.html [L]
   </IfModule>
   ```

#### é—®é¢˜3ï¼šSSLè¯ä¹¦é”™è¯¯

**æ£€æŸ¥è¯ä¹¦**ï¼š

```bash
cd /home/lw/projects/app-7z58i603if41/apache
./check-ssl.sh
```

**æŸ¥çœ‹è¯ä¹¦åŸŸå**ï¼š

```bash
openssl x509 -in wzbc-edu-cn-1024225915.crt -text -noout | grep -E "(Subject:|DNS:)"
```

å¦‚æœè¯ä¹¦åŸŸåä¸åŒ…å« `aigctmp.wzbc.edu.cn`ï¼Œéœ€è¦ï¼š
1. é‡æ–°ç”³è¯·åŒ…å«è¯¥åŸŸåçš„è¯ä¹¦
2. æˆ–ä½¿ç”¨ `*.wzbc.edu.cn` é€šé…ç¬¦è¯ä¹¦

#### é—®é¢˜4ï¼šEdge Functionè°ƒç”¨å¤±è´¥

**æ£€æŸ¥æ­¥éª¤**ï¼š

1. æµ‹è¯•Edge Functionæ˜¯å¦å¯è®¿é—®ï¼š
   ```bash
   curl -X POST https://backend.appmiaoda.com/projects/supabase254442544895672320/functions/v1/oauth-callback \
     -H "Content-Type: application/json" \
     -d '{"code":"test","state":"test"}'
   ```

2. æŸ¥çœ‹Edge Functionæ—¥å¿—ï¼š
   ```bash
   supabase functions logs oauth-callback --follow
   ```

3. æ£€æŸ¥CORSé…ç½®ï¼š
   - Edge Functionä»£ç å·²åŒ…å«CORSå¤´
   - å¦‚æœä»æœ‰CORSé”™è¯¯ï¼Œé‡æ–°éƒ¨ç½²ï¼š
     ```bash
     supabase functions deploy oauth-callback
     ```

---

## ğŸ”§ æ–¹æ¡ˆäºŒï¼šå®Œå…¨æœ¬åœ°éƒ¨ç½²

### æ¦‚è¿°

å®Œå…¨æœ¬åœ°éƒ¨ç½²éœ€è¦è‡ªè¡Œæ­å»ºåç«¯æœåŠ¡ï¼ŒåŒ…æ‹¬ï¼š
- æ•°æ®åº“æœåŠ¡å™¨ï¼ˆPostgreSQLï¼‰
- åç«¯APIæœåŠ¡å™¨ï¼ˆNode.js/Python/PHPç­‰ï¼‰
- OAuthè®¤è¯å¤„ç†
- æ–‡ä»¶ä¸Šä¼ å¤„ç†

**é¢„è®¡æ—¶é—´**ï¼š1-2å¤©

---

### ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡æœ¬åœ°æ•°æ®åº“

#### 1.1 å®‰è£…PostgreSQL

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install postgresql postgresql-contrib

# å¯åŠ¨PostgreSQL
sudo systemctl start postgresql
sudo systemctl enable postgresql

# éªŒè¯å®‰è£…
sudo systemctl status postgresql
```

#### 1.2 åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·

```bash
# åˆ‡æ¢åˆ°postgresç”¨æˆ·
sudo -u postgres psql

# åˆ›å»ºæ•°æ®åº“
CREATE DATABASE aigc_competition;

# åˆ›å»ºç”¨æˆ·
CREATE USER aigc_user WITH PASSWORD 'your_secure_password';

# æˆæƒ
GRANT ALL PRIVILEGES ON DATABASE aigc_competition TO aigc_user;

# é€€å‡º
\q
```

#### 1.3 å¯¼å…¥æ•°æ®åº“ç»“æ„

```bash
# ä½¿ç”¨é¡¹ç›®ä¸­çš„SQLæ–‡ä»¶
cd ~/projects/app-7z58i603if41
psql -U aigc_user -d aigc_competition -f supabase/migrations/20241203000000_initial_schema.sql
```

---

### ç¬¬äºŒæ­¥ï¼šå¼€å‘æœ¬åœ°åç«¯API

#### 2.1 éœ€è¦å®ç°çš„APIç«¯ç‚¹

```
# è®¤è¯ç›¸å…³
POST /api/auth/cas-callback    - CAS OAuthå›è°ƒå¤„ç†
POST /api/auth/login           - ç”¨æˆ·ç™»å½•
POST /api/auth/logout          - ç”¨æˆ·ç™»å‡º
GET  /api/auth/user            - è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯

# æŠ¥åç›¸å…³
POST /api/registrations        - åˆ›å»ºæŠ¥å
GET  /api/registrations        - è·å–æŠ¥ååˆ—è¡¨
GET  /api/registrations/:id    - è·å–æŠ¥åè¯¦æƒ…
PUT  /api/registrations/:id    - æ›´æ–°æŠ¥å
DELETE /api/registrations/:id  - åˆ é™¤æŠ¥å

# ä½œå“ç›¸å…³
POST /api/works                - åˆ›å»ºä½œå“
GET  /api/works                - è·å–ä½œå“åˆ—è¡¨
GET  /api/works/:id            - è·å–ä½œå“è¯¦æƒ…
PUT  /api/works/:id            - æ›´æ–°ä½œå“
DELETE /api/works/:id          - åˆ é™¤ä½œå“

# æ–‡ä»¶ä¸Šä¼ 
POST /api/upload               - æ–‡ä»¶ä¸Šä¼ 
```

#### 2.2 åç«¯æŠ€æœ¯æ ˆé€‰æ‹©

**é€‰é¡¹1ï¼šNode.js + Expressï¼ˆæ¨èï¼‰**

```bash
# åˆ›å»ºåç«¯é¡¹ç›®
mkdir backend
cd backend
npm init -y

# å®‰è£…ä¾èµ–
npm install express pg cors dotenv multer jsonwebtoken bcrypt axios

# åˆ›å»ºæœåŠ¡å™¨æ–‡ä»¶
touch server.js
```

**é€‰é¡¹2ï¼šPython + Flask**

```bash
# åˆ›å»ºåç«¯é¡¹ç›®
mkdir backend
cd backend
python3 -m venv venv
source venv/bin/activate

# å®‰è£…ä¾èµ–
pip install flask flask-cors psycopg2-binary python-dotenv requests

# åˆ›å»ºæœåŠ¡å™¨æ–‡ä»¶
touch app.py
```

#### 2.3 å®ç°CAS OAuthå›è°ƒå¤„ç†

å‚è€ƒ `supabase/functions/oauth-callback/index.ts` å®ç°OAuthé€»è¾‘ï¼š

1. æ¥æ”¶æˆæƒç ï¼ˆcodeï¼‰
2. ç”¨æˆæƒç æ¢å–access_token
3. ç”¨access_tokenè·å–ç”¨æˆ·ä¿¡æ¯
4. åˆ›å»ºæœ¬åœ°ä¼šè¯
5. è¿”å›ç”¨æˆ·ä¿¡æ¯

---

### ç¬¬ä¸‰æ­¥ï¼šä¿®æ”¹å‰ç«¯ä»£ç 

#### 3.1 ç§»é™¤Supabaseä¾èµ–

```bash
# å¸è½½Supabase
npm uninstall @supabase/supabase-js
```

#### 3.2 åˆ›å»ºæœ¬åœ°APIå®¢æˆ·ç«¯

åˆ›å»º `src/lib/localApi.ts`ï¼š

```typescript
const API_BASE_URL = '/api';

export const localApi = {
  // è®¤è¯
  login: async (credentials: any) => {
    const response = await fetch(`${API_BASE_URL}/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify(credentials),
    });
    return response.json();
  },

  logout: async () => {
    const response = await fetch(`${API_BASE_URL}/auth/logout`, {
      method: 'POST',
      credentials: 'include',
    });
    return response.json();
  },

  getCurrentUser: async () => {
    const response = await fetch(`${API_BASE_URL}/auth/user`, {
      credentials: 'include',
    });
    return response.json();
  },

  // æŠ¥å
  createRegistration: async (data: any) => {
    const response = await fetch(`${API_BASE_URL}/registrations`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify(data),
    });
    return response.json();
  },

  getRegistrations: async () => {
    const response = await fetch(`${API_BASE_URL}/registrations`, {
      credentials: 'include',
    });
    return response.json();
  },

  // æ›´å¤šAPIæ–¹æ³•...
};
```

#### 3.3 ä¿®æ”¹AuthContext

ä¿®æ”¹ `src/contexts/AuthContext.tsx`ï¼Œä½¿ç”¨ `localApi` æ›¿ä»£ Supabaseã€‚

#### 3.4 ä¿®æ”¹æ•°æ®åº“æ“ä½œ

ä¿®æ”¹ `src/db/api.ts`ï¼Œä½¿ç”¨ `localApi` æ›¿ä»£ Supabase æŸ¥è¯¢ã€‚

---

### ç¬¬å››æ­¥ï¼šé…ç½®Apacheåå‘ä»£ç†

#### 4.1 å¯ç”¨ä»£ç†æ¨¡å—

```bash
sudo a2enmod proxy
sudo a2enmod proxy_http
sudo systemctl restart apache2
```

#### 4.2 é…ç½®è™šæ‹Ÿä¸»æœº

ç¼–è¾‘ `/etc/apache2/sites-available/aigctmp.conf`ï¼š

```apache
<VirtualHost *:443>
    ServerName aigctmp.wzbc.edu.cn
    DocumentRoot /var/www/aigctmp

    # SSLé…ç½®
    SSLEngine on
    SSLCertificateFile /path/to/cert.crt
    SSLCertificateKeyFile /path/to/cert.key

    # å‰ç«¯é™æ€æ–‡ä»¶
    <Directory /var/www/aigctmp>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    # APIåå‘ä»£ç†
    ProxyPreserveHost On
    ProxyPass /api http://localhost:3000/api
    ProxyPassReverse /api http://localhost:3000/api

    # React Routeræ”¯æŒ
    RewriteEngine On
    RewriteCond %{REQUEST_URI} !^/api
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule . /index.html [L]

    # æ—¥å¿—
    ErrorLog ${APACHE_LOG_DIR}/aigctmp_error.log
    CustomLog ${APACHE_LOG_DIR}/aigctmp_access.log combined
</VirtualHost>
```

---

### ç¬¬äº”æ­¥ï¼šéƒ¨ç½²

#### 5.1 éƒ¨ç½²åç«¯

```bash
# Node.jsç¤ºä¾‹
cd backend
npm install

# ä½¿ç”¨PM2ç®¡ç†è¿›ç¨‹
npm install -g pm2
pm2 start server.js --name aigc-backend
pm2 save
pm2 startup

# æŸ¥çœ‹æ—¥å¿—
pm2 logs aigc-backend
```

#### 5.2 éƒ¨ç½²å‰ç«¯

```bash
# æ„å»º
npm run build

# ä¸Šä¼ 
rsync -avz --delete dist/ lw@10.145.251.29:/var/www/aigctmp/

# è®¾ç½®æƒé™
ssh lw@10.145.251.29
sudo chown -R www-data:www-data /var/www/aigctmp
sudo chmod -R 755 /var/www/aigctmp
```

#### 5.3 é‡å¯æœåŠ¡

```bash
# é‡å¯Apache
sudo systemctl restart apache2

# é‡å¯åç«¯ï¼ˆå¦‚æœéœ€è¦ï¼‰
pm2 restart aigc-backend
```

---

### ç¬¬å…­æ­¥ï¼šæµ‹è¯•

1. è®¿é—® https://aigctmp.wzbc.edu.cn
2. æµ‹è¯•ç™»å½•åŠŸèƒ½
3. æµ‹è¯•æŠ¥ååŠŸèƒ½
4. æµ‹è¯•ä½œå“æäº¤åŠŸèƒ½
5. æŸ¥çœ‹æ—¥å¿—ç¡®è®¤æ— é”™è¯¯

---

### æ³¨æ„äº‹é¡¹

âš ï¸ **å®Œå…¨æœ¬åœ°éƒ¨ç½²éœ€è¦å¤§é‡é¢å¤–å¼€å‘å·¥ä½œ**ï¼š

1. âŒ éœ€è¦å®ç°å®Œæ•´çš„åç«¯APIï¼ˆçº¦1000è¡Œä»£ç ï¼‰
2. âŒ éœ€è¦å®ç°OAuthè®¤è¯é€»è¾‘
3. âŒ éœ€è¦å®ç°æ–‡ä»¶ä¸Šä¼ å¤„ç†
4. âŒ éœ€è¦å®ç°æ•°æ®åº“æ“ä½œå’Œäº‹åŠ¡
5. âŒ éœ€è¦å®ç°æƒé™æ§åˆ¶å’Œå®‰å…¨éªŒè¯
6. âŒ éœ€è¦å®ç°é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
7. âŒ éœ€è¦é…ç½®æ•°æ®åº“å¤‡ä»½ç­–ç•¥

**å¼ºçƒˆå»ºè®®**ï¼šé™¤éæœ‰ç‰¹æ®Šè¦æ±‚ï¼ˆå¦‚æ•°æ®å®‰å…¨æ”¿ç­–ç¦æ­¢ä½¿ç”¨äº‘æœåŠ¡ï¼‰ï¼Œå¦åˆ™æ¨èä½¿ç”¨æ–¹æ¡ˆä¸€ï¼ˆSupabaseäº‘æœåŠ¡ï¼‰ã€‚

---

## ğŸ“Š æ–¹æ¡ˆå¯¹æ¯”

| ç‰¹æ€§ | æ–¹æ¡ˆä¸€ï¼ˆSupabaseï¼‰ | æ–¹æ¡ˆäºŒï¼ˆå®Œå…¨æœ¬åœ°ï¼‰ |
|------|-------------------|-------------------|
| éƒ¨ç½²æ—¶é—´ | 5åˆ†é’Ÿ | 1-2å¤© |
| å¼€å‘å·¥ä½œé‡ | æ— éœ€é¢å¤–å¼€å‘ | éœ€è¦å¼€å‘å®Œæ•´åç«¯ |
| æ•°æ®åº“é…ç½® | æ— éœ€é…ç½® | éœ€è¦é…ç½®PostgreSQL |
| åç«¯API | è‡ªåŠ¨æä¾› | éœ€è¦è‡ªè¡Œå¼€å‘ |
| æ–‡ä»¶ä¸Šä¼  | è‡ªåŠ¨å¤„ç† | éœ€è¦è‡ªè¡Œå®ç° |
| è®¤è¯ç³»ç»Ÿ | è‡ªåŠ¨å¤„ç† | éœ€è¦è‡ªè¡Œå®ç° |
| æ‰©å±•æ€§ | è‡ªåŠ¨æ‰©å±• | éœ€è¦æ‰‹åŠ¨æ‰©å±• |
| ç»´æŠ¤æˆæœ¬ | ä½ | é«˜ |
| æ•°æ®å¤‡ä»½ | è‡ªåŠ¨å¤‡ä»½ | éœ€è¦é…ç½®å¤‡ä»½ |
| æˆæœ¬ | å…è´¹ï¼ˆé¢åº¦å……è¶³ï¼‰ | æœåŠ¡å™¨æˆæœ¬ |
| æ¨èåº¦ | â­â­â­â­â­ | â­â­ |

---

## ğŸ¯ å¿«é€Ÿå‘½ä»¤å‚è€ƒ

### æ–¹æ¡ˆä¸€ï¼ˆSupabaseï¼‰

```bash
# === å®‰è£…Supabase CLI ===
npm install -g supabase

# === ç™»å½•å’Œéƒ¨ç½² ===
supabase login
supabase link --project-ref supabase254442544895672320
supabase functions deploy oauth-callback

# === å‰ç«¯æ„å»ºå’Œéƒ¨ç½² ===
npm install
npm run build
./deploy.sh

# === æŸ¥çœ‹æ—¥å¿— ===
supabase functions logs oauth-callback --follow
sudo tail -f /var/log/apache2/aigctmp_error.log

# === æµ‹è¯• ===
curl -I https://aigctmp.wzbc.edu.cn
```

### æ–¹æ¡ˆäºŒï¼ˆå®Œå…¨æœ¬åœ°ï¼‰

```bash
# === æ•°æ®åº“ ===
sudo systemctl start postgresql
psql -U aigc_user -d aigc_competition

# === åç«¯ ===
cd backend
npm install
pm2 start server.js --name aigc-backend
pm2 logs aigc-backend

# === å‰ç«¯ ===
npm run build
rsync -avz --delete dist/ user@server:/var/www/aigctmp/

# === Apache ===
sudo systemctl restart apache2
sudo tail -f /var/log/apache2/aigctmp_error.log
```

---

## â“ å¸¸è§é—®é¢˜FAQ

### Q1: æ¨èä½¿ç”¨å“ªä¸ªæ–¹æ¡ˆï¼Ÿ

**ç­”**ï¼šå¼ºçƒˆæ¨èæ–¹æ¡ˆä¸€ï¼ˆSupabaseäº‘æœåŠ¡ï¼‰ã€‚

ç†ç”±ï¼š
- éƒ¨ç½²ç®€å•ï¼Œ5åˆ†é’Ÿå®Œæˆ
- åŠŸèƒ½å®Œæ•´ï¼Œæ— éœ€é¢å¤–å¼€å‘
- å…è´¹é¢åº¦å……è¶³
- è‡ªåŠ¨æ‰©å±•å’Œå¤‡ä»½

### Q2: Supabaseå…è´¹é¢åº¦å¤Ÿç”¨å—ï¼Ÿ

**ç­”**ï¼šå®Œå…¨å¤Ÿç”¨ï¼

å…è´¹é¢åº¦åŒ…æ‹¬ï¼š
- 500,000æ¬¡Edge Functionè°ƒç”¨/æœˆ
- 500MBæ•°æ®åº“å­˜å‚¨
- 50,000ä¸ªæ´»è·ƒç”¨æˆ·
- 1GBæ–‡ä»¶å­˜å‚¨

å¯¹äºå­¦æ ¡é¡¹ç›®æ¥è¯´ç»°ç»°æœ‰ä½™ã€‚

### Q3: æ•°æ®å­˜å‚¨åœ¨å“ªé‡Œï¼Ÿ

**æ–¹æ¡ˆä¸€**ï¼šæ•°æ®å­˜å‚¨åœ¨Supabaseäº‘ç«¯ï¼ˆAWSï¼Œç¬¦åˆæ•°æ®å®‰å…¨æ ‡å‡†ï¼‰
**æ–¹æ¡ˆäºŒ**ï¼šæ•°æ®å­˜å‚¨åœ¨æœ¬åœ°æœåŠ¡å™¨

### Q4: å¦‚ä½•å¤‡ä»½æ•°æ®ï¼Ÿ

**æ–¹æ¡ˆä¸€**ï¼š
- Supabaseè‡ªåŠ¨æ¯å¤©å¤‡ä»½
- æ‰‹åŠ¨å¯¼å‡ºï¼šSupabaseæ§åˆ¶å° â†’ Database â†’ Backups

**æ–¹æ¡ˆäºŒ**ï¼š
```bash
# PostgreSQLå¤‡ä»½
pg_dump -U aigc_user aigc_competition > backup.sql

# æ¢å¤
psql -U aigc_user aigc_competition < backup.sql
```

### Q5: ç™»å½•å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

**æ£€æŸ¥æ­¥éª¤**ï¼š

1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
2. æŸ¥çœ‹Consoleæ ‡ç­¾çš„é”™è¯¯ä¿¡æ¯
3. æŸ¥çœ‹Networkæ ‡ç­¾çš„ç½‘ç»œè¯·æ±‚
4. æŸ¥çœ‹Edge Functionæ—¥å¿—ï¼š
   ```bash
   supabase functions logs oauth-callback --follow
   ```

å¸¸è§åŸå› ï¼š
- Edge Functionæœªéƒ¨ç½²
- ç¯å¢ƒå˜é‡æœªé…ç½®
- CORSé”™è¯¯

### Q6: å¦‚ä½•ä»æ–¹æ¡ˆä¸€åˆ‡æ¢åˆ°æ–¹æ¡ˆäºŒï¼Ÿ

**ä¸æ¨èåˆ‡æ¢**ï¼Œå› ä¸ºéœ€è¦ï¼š
1. å¼€å‘å®Œæ•´çš„åç«¯APIï¼ˆçº¦1000è¡Œä»£ç ï¼‰
2. ä¿®æ”¹æ‰€æœ‰å‰ç«¯ä»£ç 
3. é…ç½®æœ¬åœ°æ•°æ®åº“
4. é…ç½®åå‘ä»£ç†
5. è¿ç§»æ•°æ®

å»ºè®®ä¸€å¼€å§‹å°±é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆã€‚

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### æŸ¥çœ‹æ—¥å¿—

```bash
# æµè§ˆå™¨æ§åˆ¶å°
F12 â†’ Console

# Apacheæ—¥å¿—
sudo tail -f /var/log/apache2/aigctmp_error.log

# Edge Functionæ—¥å¿—ï¼ˆæ–¹æ¡ˆä¸€ï¼‰
supabase functions logs oauth-callback --follow

# åç«¯æ—¥å¿—ï¼ˆæ–¹æ¡ˆäºŒï¼‰
pm2 logs aigc-backend
```

### æµ‹è¯•å‘½ä»¤

```bash
# æµ‹è¯•DNSè§£æ
ping aigctmp.wzbc.edu.cn

# æµ‹è¯•HTTPS
curl -I https://aigctmp.wzbc.edu.cn

# æµ‹è¯•Apacheé…ç½®
sudo apache2ctl configtest

# æµ‹è¯•æ•°æ®åº“è¿æ¥ï¼ˆæ–¹æ¡ˆäºŒï¼‰
psql -U aigc_user -d aigc_competition -c "SELECT version();"

# æµ‹è¯•Edge Functionï¼ˆæ–¹æ¡ˆä¸€ï¼‰
curl -X POST https://backend.appmiaoda.com/projects/supabase254442544895672320/functions/v1/oauth-callback \
  -H "Content-Type: application/json" \
  -d '{"code":"test","state":"test"}'
```

---

## âœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•

### æ–¹æ¡ˆä¸€ï¼ˆSupabaseï¼‰

- [ ] Node.jså·²å®‰è£…ï¼ˆ>= 18.0.0ï¼‰
- [ ] Supabase CLIå·²å®‰è£…
- [ ] å·²ç™»å½•Supabaseè´¦å·
- [ ] é¡¹ç›®å·²å…³è”
- [ ] Edge Functionå·²éƒ¨ç½²
- [ ] Edge Functionç¯å¢ƒå˜é‡å·²é…ç½®
- [ ] å‰ç«¯å·²æ„å»º
- [ ] Apacheå·²é…ç½®
- [ ] SSLè¯ä¹¦å·²é…ç½®
- [ ] æ–‡ä»¶å·²ä¸Šä¼ åˆ°æœåŠ¡å™¨
- [ ] æƒé™å·²è®¾ç½®
- [ ] Apacheå·²é‡å¯
- [ ] å¯ä»¥è®¿é—®ç½‘ç«™
- [ ] ç™»å½•åŠŸèƒ½æ­£å¸¸
- [ ] æŠ¥ååŠŸèƒ½æ­£å¸¸

### æ–¹æ¡ˆäºŒï¼ˆå®Œå…¨æœ¬åœ°ï¼‰

- [ ] PostgreSQLå·²å®‰è£…
- [ ] æ•°æ®åº“å·²åˆ›å»º
- [ ] æ•°æ®åº“ç»“æ„å·²å¯¼å…¥
- [ ] åç«¯ä»£ç å·²å¼€å‘
- [ ] åç«¯ä¾èµ–å·²å®‰è£…
- [ ] åç«¯å·²å¯åŠ¨
- [ ] å‰ç«¯ä»£ç å·²ä¿®æ”¹
- [ ] å‰ç«¯å·²æ„å»º
- [ ] Apacheä»£ç†å·²é…ç½®
- [ ] æ–‡ä»¶å·²ä¸Šä¼ åˆ°æœåŠ¡å™¨
- [ ] æƒé™å·²è®¾ç½®
- [ ] Apacheå·²é‡å¯
- [ ] å¯ä»¥è®¿é—®ç½‘ç«™
- [ ] APIæ¥å£æ­£å¸¸
- [ ] ç™»å½•åŠŸèƒ½æ­£å¸¸
- [ ] æŠ¥ååŠŸèƒ½æ­£å¸¸

---

**æ–‡æ¡£ç‰ˆæœ¬**: 2.0  
**æœ€åæ›´æ–°**: 2025-12-03  
**é€‚ç”¨é¡¹ç›®**: æ™ºèƒ½ä½“æ¯”èµ›æŠ¥åå¹³å°  
**æ¨èæ–¹æ¡ˆ**: æ–¹æ¡ˆä¸€ï¼ˆSupabaseäº‘æœåŠ¡ï¼‰
