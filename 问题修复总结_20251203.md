# ğŸ“‹ é—®é¢˜ä¿®å¤æ€»ç»“ - 2025å¹´12æœˆ3æ—¥

## ğŸ¯ é—®é¢˜æ¦‚è¿°

### é—®é¢˜1: æµè§ˆå™¨æ˜¾ç¤º"ä¸å®‰å…¨"
- **ç°è±¡**: è®¿é—® https://aigctmp.wzbc.edu.cn æ—¶ï¼Œæµè§ˆå™¨æ˜¾ç¤º"ä¸å®‰å…¨"è­¦å‘Š
- **çŠ¶æ€**: âš ï¸ å¾…æ£€æŸ¥SSLè¯ä¹¦
- **è§£å†³æ–¹æ¡ˆ**: æŸ¥çœ‹ `é—®é¢˜æ’æŸ¥ä¸è§£å†³.md`

### é—®é¢˜2: CASç™»å½•åè¿”å›æœªç™»å½•çŠ¶æ€
- **ç°è±¡**: ç‚¹å‡»"ç»Ÿä¸€èº«ä»½è®¤è¯"ï¼ŒæˆåŠŸè¾“å…¥è´¦å·å¯†ç åè¿”å›é¡¹ç›®ç•Œé¢ä»æ˜¾ç¤ºæœªç™»å½•
- **çŠ¶æ€**: âœ… å·²ä¿®å¤ä»£ç ï¼Œå¾…éƒ¨ç½²
- **æ ¹æœ¬åŸå› **: Edge Functionæœªéƒ¨ç½²åˆ°Supabaseäº‘ç«¯

---

## âœ… å·²å®Œæˆçš„ä¿®å¤

### 1. ä¿®æ”¹å‰ç«¯OAuthå›è°ƒå¤„ç†é€»è¾‘

**æ–‡ä»¶**: `src/pages/OAuthCallbackPage.tsx`

**ä¿®æ”¹å†…å®¹**:
- âŒ æ—§ä»£ç ï¼šå°è¯•é‡å®šå‘åˆ° `/api/oauth-callback`ï¼ˆä¸å­˜åœ¨çš„ç«¯ç‚¹ï¼‰
- âœ… æ–°ä»£ç ï¼šæ­£ç¡®è°ƒç”¨Supabase Edge Function

**å…³é”®ä»£ç **:
```typescript
// è°ƒç”¨Supabase Edge Function
const { data, error } = await supabase.functions.invoke('oauth-callback', {
  body: JSON.stringify({ code, state: state || '' }),
  headers: {
    'Content-Type': 'application/json',
  },
});
```

### 2. æ›´æ–°Edge Functionä»£ç 

**æ–‡ä»¶**: `supabase/functions/oauth-callback/index.ts`

**ä¿®æ”¹å†…å®¹**:
- âœ… æ·»åŠ CORSæ”¯æŒ
- âœ… æ”¯æŒPOSTè¯·æ±‚ï¼ˆå‰ç«¯è°ƒç”¨ï¼‰
- âœ… è¿”å›JSONæ ¼å¼çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆè€Œä¸æ˜¯é‡å®šå‘ï¼‰
- âœ… æ›´æ–°redirectUriä¸ºæ­£ç¡®çš„åŸŸå

**å…³é”®æ”¹è¿›**:
```typescript
// æ·»åŠ CORSå¤´
const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

// è¿”å›JSONè€Œä¸æ˜¯é‡å®šå‘
return new Response(
  JSON.stringify({ 
    success: true,
    userInfo: userInfo,
    state: state
  }),
  {
    status: 200,
    headers: { ...corsHeaders, 'Content-Type': 'application/json' },
  }
);
```

### 3. ä¿®å¤æ„å»ºå‘½ä»¤

**æ–‡ä»¶**: `package.json`

**ä¿®æ”¹å†…å®¹**:
- âŒ æ—§ä»£ç ï¼š`"build": "echo 'Do not use this command'"`
- âœ… æ–°ä»£ç ï¼š`"build": "vite build"`

### 4. åˆ›å»ºè‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬

**æ–‡ä»¶**: `deploy-with-edge-function.sh`

**åŠŸèƒ½**:
- è‡ªåŠ¨æ£€æŸ¥å¹¶å®‰è£…Supabase CLI
- è‡ªåŠ¨ç™»å½•Supabase
- è‡ªåŠ¨å…³è”é¡¹ç›®
- è‡ªåŠ¨éƒ¨ç½²Edge Function
- è‡ªåŠ¨æ„å»ºå¹¶éƒ¨ç½²å‰ç«¯

### 5. åˆ›å»ºè¯¦ç»†æ–‡æ¡£

**æ–°å¢æ–‡æ¡£**:
- âœ… `CASç™»å½•é…ç½®æŒ‡å—.md` - è¯¦ç»†çš„é…ç½®æ­¥éª¤
- âœ… `ç™»å½•é—®é¢˜è§£å†³æ–¹æ¡ˆ.md` - é—®é¢˜åˆ†æå’Œè§£å†³æ–¹æ¡ˆ
- âœ… `å®Œæ•´éƒ¨ç½²æµç¨‹.md` - å®Œæ•´çš„éƒ¨ç½²æ–‡æ¡£
- âœ… `åŸŸåé…ç½®æŒ‡å—.md` - åŸŸåé…ç½®è¯´æ˜
- âœ… `å¿«é€Ÿéƒ¨ç½²-åŸŸåé…ç½®.md` - å¿«é€Ÿå‚è€ƒ
- âœ… `check-ssl.sh` - SSLè¯ä¹¦æ£€æŸ¥è„šæœ¬

---

## ğŸš€ ä¸‹ä¸€æ­¥æ“ä½œ

### å¿…é¡»æ‰§è¡Œçš„æ­¥éª¤

#### æ­¥éª¤1: éƒ¨ç½²Edge Function

**åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ**:

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd ~/projects/app-7z58i603if41

# è¿è¡Œè‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬
./deploy-with-edge-function.sh
```

æˆ–æ‰‹åŠ¨æ‰§è¡Œï¼š

```bash
# 1. å®‰è£…Supabase CLI
npm install -g supabase

# 2. ç™»å½•Supabase
supabase login

# 3. å…³è”é¡¹ç›®
supabase link --project-ref supabase254442544895672320

# 4. éƒ¨ç½²Edge Function
supabase functions deploy oauth-callback
```

#### æ­¥éª¤2: é…ç½®Edge Functionç¯å¢ƒå˜é‡

åœ¨Supabaseæ§åˆ¶å°é…ç½®ï¼š

1. è®¿é—® https://supabase.com
2. è¿›å…¥é¡¹ç›®
3. ç‚¹å‡» Edge Functions â†’ oauth-callback
4. æ·»åŠ ç¯å¢ƒå˜é‡ï¼š

```
OAUTH_TOKEN_URL=https://cas.wzbc.edu.cn/cas/oauth2.0/accessToken
OAUTH_USERINFO_URL=https://cas.wzbc.edu.cn/cas/oauth2.0/profile
OAUTH_CLIENT_ID=CijBwB5EwTTXouO7
OAUTH_CLIENT_SECRET=O8dOsXE7p7yMbh18KEP2Z6
OAUTH_REDIRECT_URI=https://aigctmp.wzbc.edu.cn/auth/callback
```

#### æ­¥éª¤3: é‡æ–°æ„å»ºå¹¶éƒ¨ç½²å‰ç«¯

```bash
# æ„å»º
npm run build

# éƒ¨ç½²
./deploy.sh
```

#### æ­¥éª¤4: æµ‹è¯•ç™»å½•

1. è®¿é—® https://aigctmp.wzbc.edu.cn
2. ç‚¹å‡»"ç™»å½•"
3. è¾“å…¥å­¦å·å’Œå¯†ç 
4. æ£€æŸ¥æ˜¯å¦æˆåŠŸç™»å½•

---

## ğŸ” éªŒè¯æ–¹æ³•

### æ–¹æ³•1: æŸ¥çœ‹Header

ç™»å½•æˆåŠŸåï¼ŒHeaderå³ä¸Šè§’åº”è¯¥æ˜¾ç¤ºï¼š
- âœ… ç”¨æˆ·å§“å
- âœ… "é€€å‡º"æŒ‰é’®

### æ–¹æ³•2: æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°

æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
```
æ”¶åˆ°æˆæƒç ï¼Œå¼€å§‹æ¢å–access_token...
æˆåŠŸè·å–access_tokenï¼Œå¼€å§‹è·å–ç”¨æˆ·ä¿¡æ¯...
æˆåŠŸè·å–ç”¨æˆ·ä¿¡æ¯: {...}
ç™»å½•æˆåŠŸï¼æ­£åœ¨è·³è½¬...
```

### æ–¹æ³•3: æŸ¥çœ‹Edge Functionæ—¥å¿—

```bash
supabase functions logs oauth-callback --follow
```

---

## ğŸ“Š ä¿®æ”¹æ–‡ä»¶æ¸…å•

### å‰ç«¯ä»£ç 
- âœ… `src/pages/OAuthCallbackPage.tsx` - ä¿®æ”¹OAuthå›è°ƒå¤„ç†é€»è¾‘
- âœ… `package.json` - ä¿®å¤æ„å»ºå‘½ä»¤

### Edge Function
- âœ… `supabase/functions/oauth-callback/index.ts` - æ›´æ–°Edge Functionä»£ç 

### éƒ¨ç½²è„šæœ¬
- âœ… `deploy.sh` - æ›´æ–°éƒ¨ç½²è„šæœ¬
- âœ… `deploy-with-edge-function.sh` - æ–°å¢å®Œæ•´éƒ¨ç½²è„šæœ¬
- âœ… `check-ssl.sh` - æ–°å¢SSLæ£€æŸ¥è„šæœ¬

### æ–‡æ¡£
- âœ… `CASç™»å½•é…ç½®æŒ‡å—.md` - æ–°å¢
- âœ… `ç™»å½•é—®é¢˜è§£å†³æ–¹æ¡ˆ.md` - æ–°å¢
- âœ… `å®Œæ•´éƒ¨ç½²æµç¨‹.md` - æ–°å¢
- âœ… `åŸŸåé…ç½®æŒ‡å—.md` - æ–°å¢
- âœ… `å¿«é€Ÿéƒ¨ç½²-åŸŸåé…ç½®.md` - æ–°å¢
- âœ… `é—®é¢˜æ’æŸ¥ä¸è§£å†³.md` - æ–°å¢
- âœ… `é—®é¢˜ä¿®å¤æ€»ç»“_20251203.md` - æœ¬æ–‡æ¡£

---

## ğŸ¯ å…³é”®æ”¹è¿›ç‚¹

### 1. OAuthå›è°ƒæµç¨‹ä¼˜åŒ–

**ä¹‹å‰çš„æµç¨‹**ï¼ˆé”™è¯¯ï¼‰:
```
CASè®¤è¯ â†’ å‰ç«¯å›è°ƒ â†’ é‡å®šå‘åˆ° /api/oauth-callbackï¼ˆä¸å­˜åœ¨ï¼‰â†’ å¤±è´¥
```

**ç°åœ¨çš„æµç¨‹**ï¼ˆæ­£ç¡®ï¼‰:
```
CASè®¤è¯ â†’ å‰ç«¯å›è°ƒ â†’ è°ƒç”¨Supabase Edge Function â†’ è·å–ç”¨æˆ·ä¿¡æ¯ â†’ åˆ›å»ºä¼šè¯ â†’ æˆåŠŸ
```

### 2. Edge Functionæ”¹è¿›

**ä¹‹å‰**:
- åªæ”¯æŒGETè¯·æ±‚
- è¿”å›é‡å®šå‘ï¼ˆ302ï¼‰
- æ²¡æœ‰CORSæ”¯æŒ

**ç°åœ¨**:
- æ”¯æŒGETå’ŒPOSTè¯·æ±‚
- è¿”å›JSONæ•°æ®
- å®Œæ•´çš„CORSæ”¯æŒ
- æ›´å¥½çš„é”™è¯¯å¤„ç†

### 3. éƒ¨ç½²æµç¨‹ç®€åŒ–

**ä¹‹å‰**:
- éœ€è¦æ‰‹åŠ¨æ‰§è¡Œå¤šä¸ªå‘½ä»¤
- å®¹æ˜“é—æ¼æ­¥éª¤
- æ²¡æœ‰é”™è¯¯æ£€æŸ¥

**ç°åœ¨**:
- ä¸€é”®è‡ªåŠ¨åŒ–éƒ¨ç½²
- è‡ªåŠ¨æ£€æŸ¥ä¾èµ–
- å®Œæ•´çš„é”™è¯¯æç¤º

---

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### OAuth 2.0 æµç¨‹

```
1. ç”¨æˆ·ç‚¹å‡»ç™»å½•
   â†“
2. å‰ç«¯ç”Ÿæˆstateï¼ˆé˜²CSRFï¼‰
   â†“
3. è·³è½¬åˆ°CASæˆæƒé¡µé¢
   client_id=CijBwB5EwTTXouO7
   redirect_uri=https://aigctmp.wzbc.edu.cn/auth/callback
   response_type=code
   state=éšæœºå­—ç¬¦ä¸²
   â†“
4. ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç 
   â†“
5. CASè®¤è¯æˆåŠŸï¼Œè¿”å›æˆæƒç 
   https://aigctmp.wzbc.edu.cn/auth/callback?code=xxx&state=xxx
   â†“
6. å‰ç«¯éªŒè¯state
   â†“
7. å‰ç«¯è°ƒç”¨Edge Function
   supabase.functions.invoke('oauth-callback', { body: { code, state } })
   â†“
8. Edge Functionç”¨codeæ¢å–access_token
   POST https://cas.wzbc.edu.cn/cas/oauth2.0/accessToken
   â†“
9. Edge Functionç”¨access_tokenè·å–ç”¨æˆ·ä¿¡æ¯
   GET https://cas.wzbc.edu.cn/cas/oauth2.0/profile?access_token=xxx
   â†“
10. Edge Functionè¿”å›ç”¨æˆ·ä¿¡æ¯
    { success: true, userInfo: {...} }
    â†“
11. å‰ç«¯åˆ›å»ºSupabaseä¼šè¯
    supabase.auth.signInWithPassword()
    â†“
12. ç™»å½•æˆåŠŸï¼
```

### Supabaseè®¤è¯æ–¹æ¡ˆ

ç”±äºCAS OAuthä¸æ˜¯SupabaseåŸç”Ÿæ”¯æŒçš„è®¤è¯æ–¹å¼ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†"è™šæ‹Ÿé‚®ç®±"æ–¹æ¡ˆï¼š

```typescript
// ä¸ºæ¯ä¸ªOAuthç”¨æˆ·åˆ›å»ºè™šæ‹Ÿé‚®ç®±
const virtualEmail = `${oauth_id}@oauth.wzbc.local`;
const virtualPassword = `oauth_${oauth_id}_${provider}`;

// é¦–æ¬¡ç™»å½•æ—¶æ³¨å†Œ
supabase.auth.signUp({
  email: virtualEmail,
  password: virtualPassword,
  options: {
    data: {
      oauth_id: userInfo.oauth_id,
      student_id: userInfo.student_id,
      real_name: userInfo.real_name,
      username: userInfo.username,
      provider: 'wzbc_cas'
    }
  }
});

// åç»­ç™»å½•
supabase.auth.signInWithPassword({
  email: virtualEmail,
  password: virtualPassword
});
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. SSLè¯ä¹¦é—®é¢˜

**é—®é¢˜1çš„SSLè¯ä¹¦é—®é¢˜ä»éœ€æ£€æŸ¥**ï¼

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ£€æŸ¥ï¼š
```bash
cd /home/lw/projects/app-7z58i603if41/apache
./check-ssl.sh
```

å¦‚æœè¯ä¹¦åŸŸåä¸åŒ¹é…ï¼Œéœ€è¦ï¼š
1. é‡æ–°ç”³è¯·åŒ…å« `aigctmp.wzbc.edu.cn` çš„è¯ä¹¦
2. æˆ–ä½¿ç”¨ `*.wzbc.edu.cn` é€šé…ç¬¦è¯ä¹¦

### 2. Edge Functionç¯å¢ƒå˜é‡

**å¿…é¡»åœ¨Supabaseæ§åˆ¶å°é…ç½®ç¯å¢ƒå˜é‡**ï¼Œå¦åˆ™Edge Functionä¼šä½¿ç”¨é»˜è®¤å€¼ï¼ˆå¯èƒ½ä¸æ­£ç¡®ï¼‰ã€‚

### 3. æµè§ˆå™¨ç¼“å­˜

éƒ¨ç½²åå¦‚æœçœ‹ä¸åˆ°æ›´æ–°ï¼Œè¯·ï¼š
1. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
2. æˆ–ä½¿ç”¨éšç§æ¨¡å¼è®¿é—®
3. æˆ–æŒ‰ Ctrl+Shift+R å¼ºåˆ¶åˆ·æ–°

---

## ğŸ“ æ•…éšœæ’æŸ¥

### å¦‚æœç™»å½•ä»ç„¶å¤±è´¥

1. **æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°**ï¼ˆF12 â†’ Consoleï¼‰
   - æŸ¥æ‰¾é”™è¯¯ä¿¡æ¯
   - æŸ¥çœ‹ç½‘ç»œè¯·æ±‚

2. **æŸ¥çœ‹Edge Functionæ—¥å¿—**
   ```bash
   supabase functions logs oauth-callback --follow
   ```

3. **æŸ¥çœ‹Apacheæ—¥å¿—**
   ```bash
   ssh lw@10.145.251.29
   sudo tail -f /var/log/apache2/aigctmp_error.log
   ```

4. **æµ‹è¯•Edge Function**
   ```bash
   # æµ‹è¯•Edge Functionæ˜¯å¦å¯è®¿é—®
   curl -X POST https://backend.appmiaoda.com/projects/supabase254442544895672320/functions/v1/oauth-callback \
     -H "Content-Type: application/json" \
     -d '{"code":"test","state":"test"}'
   ```

---

## âœ… æˆåŠŸæ ‡å¿—

éƒ¨ç½²æˆåŠŸåï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿï¼š

1. âœ… è®¿é—® https://aigctmp.wzbc.edu.cn
2. âœ… ç‚¹å‡»"ç™»å½•"æŒ‰é’®
3. âœ… è·³è½¬åˆ°CASè®¤è¯é¡µé¢
4. âœ… è¾“å…¥å­¦å·å’Œå¯†ç 
5. âœ… æˆåŠŸç™»å½•å¹¶è¿”å›ç½‘ç«™
6. âœ… Headeræ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯ï¼ˆå§“åï¼‰
7. âœ… å¯ä»¥è®¿é—®éœ€è¦ç™»å½•çš„é¡µé¢
8. âœ… å¯ä»¥æäº¤æŠ¥åä¿¡æ¯
9. âœ… å¯ä»¥ä¸Šä¼ ä½œå“

---

## ğŸ“š ç›¸å…³æ–‡æ¡£ç´¢å¼•

| æ–‡æ¡£åç§° | ç”¨é€” |
|---------|------|
| **CASç™»å½•é…ç½®æŒ‡å—.md** | è¯¦ç»†çš„Edge Functionéƒ¨ç½²æ­¥éª¤ |
| **ç™»å½•é—®é¢˜è§£å†³æ–¹æ¡ˆ.md** | é—®é¢˜åˆ†æå’Œè§£å†³æ–¹æ¡ˆæ€»ç»“ |
| **å®Œæ•´éƒ¨ç½²æµç¨‹.md** | å®Œæ•´çš„ç”Ÿäº§éƒ¨ç½²æµç¨‹ |
| **åŸŸåé…ç½®æŒ‡å—.md** | åŸŸåé…ç½®å’ŒSSLè®¾ç½® |
| **å¿«é€Ÿéƒ¨ç½²-åŸŸåé…ç½®.md** | å¿«é€Ÿå‚è€ƒå¡ç‰‡ |
| **é—®é¢˜æ’æŸ¥ä¸è§£å†³.md** | SSLè¯ä¹¦é—®é¢˜æ’æŸ¥ |
| **deploy-with-edge-function.sh** | è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬ |
| **check-ssl.sh** | SSLè¯ä¹¦æ£€æŸ¥è„šæœ¬ |

---

## ğŸ‰ æ€»ç»“

### å·²å®Œæˆ
- âœ… ä¿®å¤äº†OAuthå›è°ƒå¤„ç†é€»è¾‘
- âœ… æ›´æ–°äº†Edge Functionä»£ç 
- âœ… åˆ›å»ºäº†è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬
- âœ… ç¼–å†™äº†è¯¦ç»†çš„æ–‡æ¡£
- âœ… ä¿®å¤äº†æ„å»ºå‘½ä»¤

### å¾…æ‰§è¡Œ
- â³ éƒ¨ç½²Edge Functionåˆ°Supabase
- â³ é…ç½®Edge Functionç¯å¢ƒå˜é‡
- â³ é‡æ–°æ„å»ºå¹¶éƒ¨ç½²å‰ç«¯
- â³ æµ‹è¯•ç™»å½•åŠŸèƒ½
- â³ æ£€æŸ¥SSLè¯ä¹¦é—®é¢˜

### é¢„æœŸç»“æœ
- ğŸ¯ CASç™»å½•åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- ğŸ¯ ç”¨æˆ·å¯ä»¥æˆåŠŸç™»å½•
- ğŸ¯ å¯ä»¥è®¿é—®éœ€è¦ç™»å½•çš„é¡µé¢
- ğŸ¯ å¯ä»¥æäº¤æŠ¥åå’Œä½œå“

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æ›´æ–°æ—¥æœŸ**: 2025-12-03  
**ä¿®å¤äººå‘˜**: AIåŠ©æ‰‹  
**çŠ¶æ€**: ä»£ç å·²ä¿®å¤ï¼Œå¾…éƒ¨ç½²æµ‹è¯•
