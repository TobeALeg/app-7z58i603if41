# 修复401 Unauthorized错误指南

## 错误信息

```
POST https://zaozwaruaypsmmrzflvo.supabase.co/functions/v1/oauth-callback 401 (Unauthorized)
Edge Function returned a non-2xx status code
```

## 问题分析

**401 Unauthorized** 表示调用Edge Function时认证失败。可能的原因：

1. ✅ **Edge Function未部署**（最可能）
2. Edge Function环境变量未配置
3. Supabase ANON_KEY不正确
4. Supabase项目配置问题

## 关于回调地址的说明

✅ **您的配置是正确的！**

- **CAS门户回调地址**: `https://aigctmp.wzbc.edu.cn/auth/callback`
- **只需要这一个地址**

**工作流程**：
```
用户点击登录
  ↓
跳转到CAS认证页面
  ↓
输入学号密码
  ↓
CAS认证成功，返回授权码到: https://aigctmp.wzbc.edu.cn/auth/callback?code=xxx
  ↓
前端页面接收授权码
  ↓
前端调用Edge Function: supabase.functions.invoke('oauth-callback')
  ↓
Edge Function用授权码换取用户信息
  ↓
返回用户信息给前端
  ↓
前端创建Supabase会话
  ↓
登录成功
```

**CAS门户只需要配置前端回调地址**，不需要配置Edge Function地址。

---

## 解决步骤

### 步骤1：运行诊断脚本

```bash
cd ~/projects/app-7z58i603if41
./check-supabase.sh
```

这个脚本会检查：
- Supabase CLI是否安装
- 是否已登录
- 项目是否关联
- Edge Function是否部署
- .env配置是否正确
- Edge Function是否可访问

---

### 步骤2：安装并配置Supabase CLI

#### 2.1 安装Supabase CLI

```bash
npm install -g supabase
```

#### 2.2 登录Supabase

```bash
supabase login
```

这会打开浏览器，登录您的Supabase账号。

#### 2.3 关联项目

```bash
cd ~/projects/app-7z58i603if41
supabase link --project-ref supabase254442544895672320
```

**注意**: 项目引用ID可能不是 `supabase254442544895672320`，请从Supabase控制台获取正确的ID。

**获取项目引用ID的方法**：
1. 访问 https://supabase.com
2. 登录并进入项目
3. 点击 **Settings** → **General**
4. 找到 **Reference ID**

---

### 步骤3：部署Edge Function

```bash
supabase functions deploy oauth-callback
```

**预期输出**：
```
Deploying Function oauth-callback...
Deployed Function oauth-callback
Function URL: https://xxx.supabase.co/functions/v1/oauth-callback
```

---

### 步骤4：配置Edge Function环境变量

**重要**: 必须在Supabase控制台配置环境变量！

#### 4.1 访问Supabase控制台

1. 打开 https://supabase.com
2. 登录并进入项目
3. 点击左侧菜单 **Edge Functions**
4. 点击 **oauth-callback** 函数

#### 4.2 添加环境变量

1. 点击 **Settings** 标签
2. 点击 **Secrets** 子标签
3. 点击 **Add new secret** 按钮
4. 逐个添加以下变量：

| 变量名 | 值 |
|--------|-----|
| `OAUTH_TOKEN_URL` | `https://cas.wzbc.edu.cn/cas/oauth2.0/accessToken` |
| `OAUTH_USERINFO_URL` | `https://cas.wzbc.edu.cn/cas/oauth2.0/profile` |
| `OAUTH_CLIENT_ID` | `CijBwB5EwTTXouO7` |
| `OAUTH_CLIENT_SECRET` | `O8dOsXE7p7yMbh18KEP2Z6` |
| `OAUTH_REDIRECT_URI` | `https://aigctmp.wzbc.edu.cn/auth/callback` |

**每添加一个变量后，点击 Save 保存！**

---

### 步骤5：验证Edge Function

#### 5.1 查看Edge Function列表

```bash
supabase functions list
```

应该能看到 `oauth-callback` 函数。

#### 5.2 查看Edge Function日志

```bash
supabase functions logs oauth-callback --follow
```

保持这个终端打开，然后在另一个终端或浏览器中测试登录。

#### 5.3 测试Edge Function

```bash
# 从.env文件获取配置
SUPABASE_URL=$(cat .env | grep VITE_SUPABASE_URL | cut -d '=' -f2)
SUPABASE_KEY=$(cat .env | grep VITE_SUPABASE_ANON_KEY | cut -d '=' -f2)

# 测试Edge Function
curl -X POST "${SUPABASE_URL}/functions/v1/oauth-callback" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer ${SUPABASE_KEY}" \
  -d '{"code":"test","state":"test"}'
```

**预期结果**：
- **200或400**: Edge Function正常工作（400是因为test code无效，但说明函数可访问）
- **401**: 认证失败，检查ANON_KEY
- **404**: Edge Function未部署

---

### 步骤6：更新Supabase配置（如果需要）

如果您的Supabase项目URL不是 `https://backend.appmiaoda.com/projects/supabase254442544895672320`，需要更新`.env`文件。

#### 6.1 获取正确的Supabase URL

1. 访问 https://supabase.com
2. 进入项目
3. 点击 **Settings** → **API**
4. 找到 **Project URL** 和 **anon public key**

#### 6.2 更新.env文件

```bash
nano .env
```

更新为：
```bash
VITE_APP_ID=app-7z58i603if41
VITE_SUPABASE_URL=你的项目URL
VITE_SUPABASE_ANON_KEY=你的anon_key
```

---

### 步骤7：重新构建并部署

```bash
# 构建项目
npm run build

# 部署到服务器
./deploy.sh
```

---

### 步骤8：测试登录

1. 清除浏览器缓存（或使用隐私模式）
2. 访问 https://aigctmp.wzbc.edu.cn
3. 按 **F12** 打开开发者工具
4. 切换到 **Console** 标签
5. 点击"登录"按钮
6. 输入学号和密码
7. 查看控制台输出

**正常日志应该包含**：
```
开始调用Edge Function，参数: { code: "...", state: "..." }
Edge Function响应: { data: { success: true, userInfo: {...} }, error: null }
登录成功！正在跳转...
```

---

## 常见问题排查

### 问题1: "supabase命令不存在"

**解决**：
```bash
npm install -g supabase
```

### 问题2: "未登录Supabase"

**解决**：
```bash
supabase login
```

### 问题3: "项目未关联"

**解决**：
```bash
supabase link --project-ref <你的项目ID>
```

### 问题4: "Edge Function未部署"

**解决**：
```bash
supabase functions deploy oauth-callback
```

### 问题5: "仍然返回401"

**可能原因**：
1. ANON_KEY不正确
2. Edge Function环境变量未配置
3. Supabase URL不正确

**检查步骤**：
```bash
# 1. 检查.env文件
cat .env

# 2. 检查Edge Function列表
supabase functions list

# 3. 查看Edge Function日志
supabase functions logs oauth-callback --follow

# 4. 测试Edge Function
./check-supabase.sh
```

---

## 完整修复命令（一键执行）

```bash
#!/bin/bash

# 进入项目目录
cd ~/projects/app-7z58i603if41

# 1. 安装Supabase CLI
echo "1. 安装Supabase CLI..."
npm install -g supabase

# 2. 登录Supabase
echo "2. 登录Supabase..."
supabase login

# 3. 关联项目
echo "3. 关联项目..."
supabase link --project-ref supabase254442544895672320

# 4. 部署Edge Function
echo "4. 部署Edge Function..."
supabase functions deploy oauth-callback

# 5. 提示配置环境变量
echo ""
echo "========================================="
echo "  重要：配置Edge Function环境变量"
echo "========================================="
echo ""
echo "请访问 Supabase 控制台配置以下环境变量："
echo ""
echo "1. 访问: https://supabase.com"
echo "2. 进入项目 → Edge Functions → oauth-callback"
echo "3. Settings → Secrets"
echo "4. 添加以下变量："
echo ""
echo "  OAUTH_TOKEN_URL=https://cas.wzbc.edu.cn/cas/oauth2.0/accessToken"
echo "  OAUTH_USERINFO_URL=https://cas.wzbc.edu.cn/cas/oauth2.0/profile"
echo "  OAUTH_CLIENT_ID=CijBwB5EwTTXouO7"
echo "  OAUTH_CLIENT_SECRET=O8dOsXE7p7yMbh18KEP2Z6"
echo "  OAUTH_REDIRECT_URI=https://aigctmp.wzbc.edu.cn/auth/callback"
echo ""
read -p "配置完成后，按回车继续..."

# 6. 测试Edge Function
echo ""
echo "6. 测试Edge Function..."
./check-supabase.sh

# 7. 重新构建并部署
echo ""
echo "7. 重新构建并部署..."
npm run build
./deploy.sh

echo ""
echo "========================================="
echo "  部署完成！"
echo "========================================="
echo ""
echo "请访问 https://aigctmp.wzbc.edu.cn 测试登录功能"
echo ""
```

将以上脚本保存为 `fix-401.sh`，然后执行：

```bash
chmod +x fix-401.sh
./fix-401.sh
```

---

## 验证清单

部署完成后，请确认以下所有项目：

### Supabase配置
- [ ] Supabase CLI已安装（`supabase --version`）
- [ ] 已登录Supabase（`supabase projects list`）
- [ ] 项目已关联（`.supabase/config.toml` 文件存在）
- [ ] Edge Function已部署（`supabase functions list` 能看到）
- [ ] 所有5个环境变量已在控制台配置
- [ ] Edge Function测试通过（`./check-supabase.sh`）

### 前端配置
- [ ] `.env` 文件配置正确
- [ ] `VITE_SUPABASE_URL` 正确
- [ ] `VITE_SUPABASE_ANON_KEY` 正确
- [ ] 项目已重新构建（`npm run build`）
- [ ] 文件已上传到服务器
- [ ] Apache已重启

### 功能测试
- [ ] 可以访问网站
- [ ] 点击登录能跳转到CAS
- [ ] 输入账号密码后能返回网站
- [ ] 浏览器控制台无401错误
- [ ] Edge Function日志显示正常
- [ ] 登录成功，Header显示用户信息

---

## 需要帮助？

如果按照以上步骤仍然无法解决问题，请提供：

1. **诊断脚本输出**：
   ```bash
   ./check-supabase.sh > diagnostic.log 2>&1
   cat diagnostic.log
   ```

2. **Edge Function日志**：
   ```bash
   supabase functions logs oauth-callback --limit 50
   ```

3. **浏览器控制台完整输出**（F12 → Console）

4. **网络请求详情**（F12 → Network → oauth-callback请求）

---

**文档版本**: 1.0  
**最后更新**: 2025-12-03  
**适用错误**: 401 Unauthorized - Edge Function认证失败
