# Apache配置示例 - aigc.wzbc.edu.cn
# 智能体比赛报名平台 HTTPS配置

# HTTPS虚拟主机配置
<VirtualHost *:443>
    ServerName aigc.wzbc.edu.cn
    ServerAdmin admin@wzbc.edu.cn
    DocumentRoot /var/www/html
    
    # SSL配置
    SSLEngine on
    SSLCertificateFile /path/to/aigc.wzbc.edu.cn.crt
    SSLCertificateKeyFile /path/to/aigc.wzbc.edu.cn.key
    SSLCertificateChainFile /path/to/ca_bundle.crt
    
    # SSL安全配置
    SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite HIGH:!aNULL:!MD5:!3DES
    SSLHonorCipherOrder on
    
    # 启用HTTP/2（如果支持）
    Protocols h2 http/1.1
    
    # 日志配置
    ErrorLog ${APACHE_LOG_DIR}/aigc-error.log
    CustomLog ${APACHE_LOG_DIR}/aigc-access.log combined
    
    # 静态文件目录配置
    <Directory /var/www/html>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # 启用压缩
        <IfModule mod_deflate.c>
            AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
        </IfModule>
        
        # 浏览器缓存
        <IfModule mod_expires.c>
            ExpiresActive On
            # 图片缓存1年
            ExpiresByType image/jpg "access plus 1 year"
            ExpiresByType image/jpeg "access plus 1 year"
            ExpiresByType image/gif "access plus 1 year"
            ExpiresByType image/png "access plus 1 year"
            ExpiresByType image/svg+xml "access plus 1 year"
            ExpiresByType image/webp "access plus 1 year"
            ExpiresByType image/x-icon "access plus 1 year"
            
            # CSS和JS缓存1个月
            ExpiresByType text/css "access plus 1 month"
            ExpiresByType application/javascript "access plus 1 month"
            
            # 字体缓存1年
            ExpiresByType font/woff "access plus 1 year"
            ExpiresByType font/woff2 "access plus 1 year"
            ExpiresByType application/font-woff "access plus 1 year"
            ExpiresByType application/font-woff2 "access plus 1 year"
            
            # HTML不缓存
            ExpiresByType text/html "access plus 0 seconds"
        </IfModule>
    </Directory>
    
    # SPA路由支持 - 所有请求重定向到index.html
    <IfModule mod_rewrite.c>
        RewriteEngine On
        RewriteBase /
        
        # 如果请求的是index.html，直接返回
        RewriteRule ^index\.html$ - [L]
        
        # 如果请求的文件或目录存在，直接返回
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        
        # 否则重定向到index.html
        RewriteRule . /index.html [L]
    </IfModule>
    
    # 安全响应头
    <IfModule mod_headers.c>
        # HTTPS强制（HSTS）
        Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        
        # XSS保护
        Header always set X-XSS-Protection "1; mode=block"
        
        # 防止点击劫持
        Header always set X-Frame-Options "SAMEORIGIN"
        
        # 内容类型嗅探保护
        Header always set X-Content-Type-Options "nosniff"
        
        # Referrer策略
        Header always set Referrer-Policy "strict-origin-when-cross-origin"
        
        # 权限策略
        Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
        
        # 内容安全策略（根据实际需求调整）
        Header always set Content-Security-Policy "default-src 'self' https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: https:; font-src 'self' data: https:; connect-src 'self' https://cas.wzbc.edu.cn https://*.supabase.co https://*.supabase.in;"
        
        # 移除服务器版本信息
        Header always unset X-Powered-By
        Header always unset Server
    </IfModule>
</VirtualHost>

# HTTP到HTTPS重定向
<VirtualHost *:80>
    ServerName aigc.wzbc.edu.cn
    ServerAdmin admin@wzbc.edu.cn
    
    # 日志配置
    ErrorLog ${APACHE_LOG_DIR}/aigc-redirect-error.log
    CustomLog ${APACHE_LOG_DIR}/aigc-redirect-access.log combined
    
    # 永久重定向到HTTPS
    Redirect permanent / https://aigc.wzbc.edu.cn/
</VirtualHost>

# 全局安全配置
<IfModule mod_security2.c>
    # 启用ModSecurity（如果已安装）
    SecRuleEngine On
</IfModule>

# 隐藏Apache版本信息
ServerTokens Prod
ServerSignature Off

# 禁用目录浏览
Options -Indexes

# 文件上传大小限制（如果需要）
LimitRequestBody 10485760
