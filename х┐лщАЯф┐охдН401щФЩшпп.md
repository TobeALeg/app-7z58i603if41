# 快速修复401错误

## 问题

登录时出现错误：
```
POST https://xxx.supabase.co/functions/v1/oauth-callback 401 (Unauthorized)
```

## 原因

**Edge Function未部署或环境变量未配置**

## 关于回调地址

✅ **您的CAS门户配置是正确的！**

- **回调地址**: `https://aigctmp.wzbc.edu.cn/auth/callback`
- **只需要这一个地址**
- **不需要配置Edge Function地址**

## 一键修复

在服务器上执行：

```bash
cd ~/projects/app-7z58i603if41
./fix-401.sh
```

脚本会自动：
1. ✅ 安装Supabase CLI
2. ✅ 登录Supabase
3. ✅ 关联项目
4. ✅ 部署Edge Function
5. ⚠️ **提示您配置环境变量（必须手动完成）**
6. ✅ 测试Edge Function
7. ✅ 重新构建并部署

## 重要：配置环境变量

**必须在Supabase控制台手动配置！**

### 步骤

1. 访问 https://supabase.com
2. 登录并进入项目
3. 点击 **Edge Functions** → **oauth-callback**
4. 点击 **Settings** → **Secrets**
5. 点击 **Add new secret**
6. 逐个添加以下5个变量：

```bash
OAUTH_TOKEN_URL=https://cas.wzbc.edu.cn/cas/oauth2.0/accessToken
OAUTH_USERINFO_URL=https://cas.wzbc.edu.cn/cas/oauth2.0/profile
OAUTH_CLIENT_ID=CijBwB5EwTTXouO7
OAUTH_CLIENT_SECRET=O8dOsXE7p7yMbh18KEP2Z6
OAUTH_REDIRECT_URI=https://aigctmp.wzbc.edu.cn/auth/callback
```

**每添加一个变量后，点击Save保存！**

## 测试

1. 访问 https://aigctmp.wzbc.edu.cn
2. 按 **F12** 打开开发者工具
3. 点击"登录"
4. 输入学号和密码
5. 查看控制台，应该不再有401错误

## 仍然失败？

查看详细指南：
```bash
cat 修复401错误指南.md
```

或运行诊断：
```bash
./check-supabase.sh
```

查看Edge Function日志：
```bash
supabase functions logs oauth-callback --follow
```

---

**关键点**：
- ✅ CAS回调地址配置正确
- ⚠️ 必须部署Edge Function
- ⚠️ 必须配置5个环境变量
