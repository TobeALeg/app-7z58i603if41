# 解决500错误 - OAuth Token请求失败

## 问题现象

Edge Function返回500错误：
```json
{
  "error": "获取access_token失败",
  "details": "error=invalid_request"
}
```

## 问题原因

**OAuth token请求使用了错误的HTTP方法**

- ❌ 之前使用：GET请求
- ✅ 应该使用：POST请求

CAS OAuth 2.0标准要求token endpoint使用POST方法。

## 已修复的内容

### 1. 修改HTTP请求方法

```typescript
// 之前（错误）
const tokenResponse = await fetch(`${OAUTH_CONFIG.tokenUrl}?${tokenParams}`, {
  method: 'GET',
  headers: {
    'Accept': 'application/json',
  },
});

// 现在（正确）
const tokenResponse = await fetch(`${OAUTH_CONFIG.tokenUrl}?${tokenParams}`, {
  method: 'POST',
  headers: {
    'Accept': 'application/json',
    'Content-Type': 'application/x-www-form-urlencoded',
  },
});
```

### 2. 添加详细日志

现在Edge Function会记录：
- Token URL
- Client ID
- Redirect URI
- 完整的请求URL
- Token响应数据
- 详细的错误信息

### 3. 改进错误处理

错误响应现在包含更多信息：
```json
{
  "error": "获取access_token失败",
  "details": "错误详情",
  "status": 400
}
```

## 重新部署Edge Function

### 方法1：使用自动化脚本（推荐）

```bash
cd ~/projects/app-7z58i603if41
./redeploy-edge-function.sh
```

脚本会自动：
1. ✅ 检查Supabase CLI
2. ✅ 检查登录状态
3. ✅ 检查项目关联
4. ✅ 重新部署Edge Function
5. ✅ 显示最新日志

### 方法2：手动部署

```bash
cd ~/projects/app-7z58i603if41

# 重新部署
supabase functions deploy oauth-callback

# 查看日志
supabase functions logs oauth-callback --follow
```

## 测试修复结果

### 1. 测试Edge Function

```bash
./check-supabase.sh
```

**预期结果**：
- HTTP状态码应该是200或400（不再是500）
- 如果是400，错误信息应该是"invalid_grant"（因为test code无效）
- 如果是500且错误是"invalid_request"，说明还有问题

### 2. 测试真实登录

1. 访问 https://aigctmp.wzbc.edu.cn
2. 按 **F12** 打开开发者工具
3. 切换到 **Console** 标签
4. 点击"登录"按钮
5. 输入学号和密码
6. 查看控制台输出

**正常日志应该包含**：
```
开始调用Edge Function，参数: { code: "...", state: "..." }
Edge Function响应: { data: { success: true, userInfo: {...} }, error: null }
登录成功！正在跳转...
```

### 3. 查看Edge Function日志

在另一个终端窗口：
```bash
supabase functions logs oauth-callback --follow
```

然后在浏览器中测试登录，实时查看日志。

**正常日志应该包含**：
```
收到授权码，开始换取access_token...
Token URL: https://cas.wzbc.edu.cn/cas/oauth2.0/accessToken
Client ID: CijBwB5EwTTXouO7
Redirect URI: https://aigctmp.wzbc.edu.cn/auth/callback
请求Token URL: https://cas.wzbc.edu.cn/cas/oauth2.0/accessToken?grant_type=...
Token响应: { access_token: "...", ... }
成功获取access_token，开始获取用户信息...
成功获取用户信息: { id: "...", attributes: {...} }
```

## 可能遇到的其他错误

### 错误1: "invalid_grant"

**含义**：授权码无效或已过期

**原因**：
- 授权码只能使用一次
- 授权码有效期很短（通常10秒）
- 重复提交了相同的授权码

**解决**：
- 这是正常的，重新登录即可
- 不要刷新回调页面

### 错误2: "redirect_uri_mismatch"

**含义**：回调地址不匹配

**检查**：
1. Edge Function环境变量中的 `OAUTH_REDIRECT_URI`
2. CAS门户中配置的回调地址
3. 前端发起OAuth请求时的redirect_uri参数

**确保三者完全一致**：
```
https://aigctmp.wzbc.edu.cn/auth/callback
```

### 错误3: "invalid_client"

**含义**：客户端ID或密钥错误

**检查**：
1. Edge Function环境变量中的 `OAUTH_CLIENT_ID`
2. Edge Function环境变量中的 `OAUTH_CLIENT_SECRET`
3. 与CAS门户中的配置是否一致

**查看已配置的环境变量**：
```bash
supabase secrets list
```

## 完整的工作流程

```
用户点击登录
  ↓
跳转到CAS认证页面
  ↓
输入学号密码
  ↓
CAS认证成功，返回授权码
  ↓
前端接收授权码: https://aigctmp.wzbc.edu.cn/auth/callback?code=xxx
  ↓
前端调用Edge Function: supabase.functions.invoke('oauth-callback', { body: { code } })
  ↓
Edge Function用授权码换取access_token (POST请求) ✅
  ↓
Edge Function用access_token获取用户信息
  ↓
Edge Function返回用户信息给前端
  ↓
前端创建Supabase会话
  ↓
登录成功，跳转到首页
```

## 验证清单

重新部署后，请确认：

- [ ] Edge Function已重新部署（`supabase functions list`）
- [ ] 测试脚本返回200或400（不是500）
- [ ] 可以访问网站
- [ ] 点击登录能跳转到CAS
- [ ] 输入账号密码后能返回网站
- [ ] 浏览器控制台无500错误
- [ ] Edge Function日志显示"成功获取access_token"
- [ ] 登录成功，Header显示用户信息

## 快速命令参考

```bash
# 重新部署Edge Function
./redeploy-edge-function.sh

# 或手动部署
supabase functions deploy oauth-callback

# 测试Edge Function
./check-supabase.sh

# 查看实时日志
supabase functions logs oauth-callback --follow

# 查看最近日志
supabase functions logs oauth-callback --limit 50

# 查看环境变量
supabase secrets list
```

## 需要帮助？

如果重新部署后仍然失败，请提供：

1. **重新部署的输出**：
   ```bash
   ./redeploy-edge-function.sh 2>&1 | tee deploy.log
   ```

2. **测试结果**：
   ```bash
   ./check-supabase.sh 2>&1 | tee test.log
   ```

3. **Edge Function日志**：
   ```bash
   supabase functions logs oauth-callback --limit 50
   ```

4. **浏览器控制台完整输出**（F12 → Console）

5. **网络请求详情**（F12 → Network → oauth-callback请求）

---

**文档版本**: 1.0  
**最后更新**: 2025-12-03  
**适用错误**: HTTP 500 - 获取access_token失败
