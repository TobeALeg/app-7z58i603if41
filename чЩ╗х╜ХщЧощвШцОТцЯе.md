# 登录问题排查指南

## 问题现象

**错误提示**: "Edge Function returned a non-2xx status code"

**发生时机**: 在CAS认证页面输入账号密码后，返回到网站时

---

## 问题原因

这个错误表示Edge Function（用于处理OAuth认证的云函数）调用失败。可能的原因包括：

1. ✅ **Edge Function未部署**（最常见）
2. Edge Function环境变量未配置
3. Edge Function代码执行出错
4. 网络连接问题

---

## 解决步骤

### 第1步：检查Edge Function是否已部署

```bash
# 在服务器上执行
cd ~/projects/app-7z58i603if41

# 检查Supabase CLI是否已安装
supabase --version

# 如果未安装，先安装
npm install -g supabase

# 登录Supabase
supabase login

# 关联项目
supabase link --project-ref supabase254442544895672320

# 检查Edge Function列表
supabase functions list
```

**预期结果**: 应该能看到 `oauth-callback` 函数

**如果看不到**: 说明Edge Function未部署，执行第2步

---

### 第2步：部署Edge Function

```bash
# 部署oauth-callback函数
supabase functions deploy oauth-callback

# 等待部署完成（约30秒）
```

**成功标志**: 
```
Deployed Function oauth-callback
Function URL: https://...
```

---

### 第3步：配置Edge Function环境变量

**重要**: 即使Edge Function已部署，如果环境变量未配置，也会导致认证失败。

#### 3.1 访问Supabase控制台

1. 打开浏览器访问: https://supabase.com
2. 登录您的账号
3. 选择项目

#### 3.2 配置环境变量

1. 点击左侧菜单 **Edge Functions**
2. 点击 **oauth-callback** 函数
3. 点击 **Settings** 标签
4. 点击 **Secrets** 子标签
5. 点击 **Add new secret** 按钮

#### 3.3 添加以下环境变量

| 变量名 | 值 |
|--------|-----|
| `OAUTH_TOKEN_URL` | `https://cas.wzbc.edu.cn/cas/oauth2.0/accessToken` |
| `OAUTH_USERINFO_URL` | `https://cas.wzbc.edu.cn/cas/oauth2.0/profile` |
| `OAUTH_CLIENT_ID` | `CijBwB5EwTTXouO7` |
| `OAUTH_CLIENT_SECRET` | `O8dOsXE7p7yMbh18KEP2Z6` |
| `OAUTH_REDIRECT_URI` | `https://aigctmp.wzbc.edu.cn/auth/callback` |

**注意**: 每添加一个变量后，点击 **Save** 保存

---

### 第4步：重新构建并部署前端

```bash
# 在项目目录执行
cd ~/projects/app-7z58i603if41

# 构建项目
npm run build

# 部署到服务器
./deploy.sh
```

---

### 第5步：测试登录

1. 清除浏览器缓存（或使用隐私模式）
2. 访问: https://aigctmp.wzbc.edu.cn
3. 点击"登录"按钮
4. 输入学号和密码
5. 检查是否成功登录

---

## 查看详细错误信息

### 方法1: 浏览器控制台

1. 按 **F12** 打开开发者工具
2. 切换到 **Console** 标签
3. 点击登录
4. 查看控制台输出

**关键日志**:
```
开始调用Edge Function，参数: { code: "...", state: "..." }
Edge Function响应: { data: ..., error: ... }
```

如果有错误，会显示详细的错误信息。

---

### 方法2: Edge Function日志

```bash
# 实时查看Edge Function日志
supabase functions logs oauth-callback --follow
```

**正常日志应该包含**:
```
收到授权码，开始换取access_token...
成功获取access_token，开始获取用户信息...
成功获取用户信息: {...}
```

**如果看到错误**:
- `Token exchange failed` - OAuth配置错误
- `User info fetch failed` - 用户信息获取失败
- `Missing environment variable` - 环境变量未配置

---

## 常见错误及解决方案

### 错误1: "Function not found"

**原因**: Edge Function未部署

**解决**:
```bash
supabase functions deploy oauth-callback
```

---

### 错误2: "获取access_token失败"

**原因**: OAuth配置错误或环境变量未配置

**检查**:
1. 确认环境变量已在Supabase控制台配置
2. 确认 `OAUTH_CLIENT_ID` 和 `OAUTH_CLIENT_SECRET` 正确
3. 确认 `OAUTH_REDIRECT_URI` 与CAS系统配置一致

**解决**:
- 重新检查并配置环境变量
- 联系CAS系统管理员确认OAuth配置

---

### 错误3: "CORS error"

**原因**: Edge Function未正确配置CORS头

**解决**:
Edge Function代码已包含CORS头，重新部署即可：
```bash
supabase functions deploy oauth-callback
```

---

### 错误4: "Network error"

**原因**: 网络连接问题

**检查**:
```bash
# 测试Edge Function是否可访问
curl -X POST https://backend.appmiaoda.com/projects/supabase254442544895672320/functions/v1/oauth-callback \
  -H "Content-Type: application/json" \
  -d '{"code":"test","state":"test"}'
```

**预期结果**: 应该返回JSON响应（即使是错误响应也说明函数可访问）

---

## 完整检查清单

部署前请确认以下所有项目：

### Supabase配置
- [ ] Supabase CLI已安装
- [ ] 已登录Supabase账号
- [ ] 项目已关联（`supabase link`）
- [ ] Edge Function已部署（`supabase functions list` 能看到）
- [ ] 所有环境变量已配置（5个变量）
- [ ] 环境变量值正确无误

### 前端配置
- [ ] `.env` 文件存在
- [ ] `VITE_SUPABASE_URL` 配置正确
- [ ] `VITE_SUPABASE_ANON_KEY` 配置正确
- [ ] 项目已重新构建（`npm run build`）
- [ ] 文件已上传到服务器
- [ ] Apache已重启

### 测试验证
- [ ] 可以访问网站
- [ ] 点击登录能跳转到CAS
- [ ] 输入账号密码后能返回网站
- [ ] 浏览器控制台无错误
- [ ] Edge Function日志正常

---

## 快速修复命令

如果您确定是Edge Function未部署导致的问题，可以执行以下命令快速修复：

```bash
# 一键修复脚本
cd ~/projects/app-7z58i603if41

# 1. 安装Supabase CLI（如果未安装）
npm install -g supabase

# 2. 登录Supabase
supabase login

# 3. 关联项目
supabase link --project-ref supabase254442544895672320

# 4. 部署Edge Function
supabase functions deploy oauth-callback

# 5. 重新构建并部署前端
npm run build
./deploy.sh

# 6. 查看Edge Function日志
supabase functions logs oauth-callback --follow
```

**然后**:
1. 访问Supabase控制台配置环境变量（必须手动配置）
2. 测试登录功能

---

## 仍然无法解决？

### 收集诊断信息

```bash
# 1. 检查Supabase CLI版本
supabase --version

# 2. 检查项目关联状态
supabase status

# 3. 检查Edge Function列表
supabase functions list

# 4. 查看Edge Function日志
supabase functions logs oauth-callback --limit 50

# 5. 测试Edge Function
curl -X POST https://backend.appmiaoda.com/projects/supabase254442544895672320/functions/v1/oauth-callback \
  -H "Content-Type: application/json" \
  -d '{"code":"test","state":"test"}' -v
```

### 查看浏览器网络请求

1. 按 **F12** 打开开发者工具
2. 切换到 **Network** 标签
3. 点击登录
4. 找到 `oauth-callback` 请求
5. 查看请求详情：
   - Request Headers
   - Request Payload
   - Response Headers
   - Response Body

### 联系支持

如果以上步骤都无法解决问题，请提供：
1. 浏览器控制台完整错误信息
2. Edge Function日志
3. 网络请求详情
4. Supabase CLI版本和状态

---

## 预防措施

为避免将来出现类似问题：

1. **定期检查Edge Function状态**
   ```bash
   supabase functions list
   ```

2. **监控Edge Function日志**
   ```bash
   supabase functions logs oauth-callback --follow
   ```

3. **备份环境变量配置**
   - 将环境变量保存到安全的地方
   - 定期检查配置是否正确

4. **测试登录功能**
   - 每次部署后测试登录
   - 使用不同浏览器测试

---

**文档版本**: 1.0  
**最后更新**: 2025-12-03  
**适用问题**: Edge Function调用失败导致的登录问题
